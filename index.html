<!-- <!doctype html>
<html lang="en" x-data="app()" x-init="init()" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBOM Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    .card{ @apply bg-white border rounded-2xl shadow-sm p-4; }
    .chip{ @apply text-xs px-2 py-0.5 rounded; }
    [x-cloak]{ display:none !important; }
    .muted{ @apply text-xs text-gray-500; }
  </style>
</head>
<body class="h-full">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-semibold">SBOM Explorer</h1>
      <span class="text-xs text-gray-500" x-text="metaText"></span>
      <div class="ml-auto flex gap-2">
        <button class="px-3 py-2 border rounded-xl" @click="exportCSV()">Export CSV</button>
        <button class="px-3 py-2 border rounded-xl" @click="saveView()">Save View</button>
        <button class="px-3 py-2 border rounded-xl" @click="loadView()">Load View</button>
      </div>
    </div>
    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-4 pb-3 flex items-center gap-2 flex-wrap">
      <input x-model="q" @input="applyFilters(true)" placeholder="Search (component, purl, vuln id, license)"
        class="w-72 px-3 py-2 border rounded-xl focus:outline-none focus:ring" />
      <select x-model="dataset" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl">
        <option value="">All datasets</option>
        <template x-for="d in datasets" :key="d.id">
          <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
        </template>
      </select>
      <select x-model="severity" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl">
        <option value="">All severities</option>
        <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN']" :key="s">
          <option :value="s" x-text="s"></option>
        </template>
      </select>
      <select x-model="fix" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl">
        <option value="">Fix status</option>
        <option value="has">Has fix</option>
        <option value="none">No fix</option>
      </select>
      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <span class="text-sm">CVSS ≥</span>
        <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin" @input="applyFilters(true)" class="w-20 outline-none" />
      </label>
      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <input type="checkbox" x-model="onlyDirect" @change="applyFilters(true)">
        <span class="text-sm">Only direct</span>
      </label>
      <div class="ml-auto flex items-center gap-2 text-sm">
        <label>Sort:</label>
        <select x-model="sortKey" @change="applyFilters()" class="px-2 py-1 border rounded-lg">
          <option value="severityRank">Severity</option>
          <option value="cvss">CVSS</option>
          <option value="component">Component</option>
          <option value="dataset">Dataset</option>
        </select>
        <button class="px-2 py-1 border rounded-lg" @click="sortDir = sortDir==='desc'?'asc':'desc'; applyFilters()"
                x-text="sortDir==='desc' ? '↓' : '↑'"></button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Findings summary: totals + donut + sparklines + new metrics -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
      <!-- Totals + sparks -->
      <div class="lg:col-span-7 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="card col-span-2">
          <div class="text-xs text-gray-500">Total Vulnerabilities</div>
          <div class="text-2xl font-semibold" x-text="overall.total"></div>
          <div class="text-xs mt-1" x-html="deltaBadge(overall.delta)"></div>
          <canvas id="sparkTotal" height="40" class="mt-2"></canvas>
        </div>
        <template x-for="sev in ['CRITICAL','HIGH','MEDIUM','LOW']" :key="sev">
          <div class="card">
            <div class="text-xs text-gray-500" x-text="sev"></div>
            <div class="text-xl font-semibold" x-text="overall.severityCounts[sev] ?? 0"></div>
            <div class="text-xs mt-1" x-html="deltaBadge(overall.severityDelta[sev])"></div>
            <canvas :id="`spark-${sev}`" height="40" class="mt-2"></canvas>
          </div>
        </template>
      </div>
      <!-- Donut -->
      <div class="card lg:col-span-5">
        <div class="text-sm font-medium mb-2">Severity distribution</div>
        <canvas id="donut" height="160"></canvas>
      </div>
    </section>

    <!-- New metric cards -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card">
        <div class="text-xs text-gray-500">Fix availability rate</div>
        <div class="text-2xl font-semibold" x-text="(metrics.fixAvailabilityRate||0) + '%'"></div>
        <div class="muted mt-1">% of current vulns with known fixes</div>
      </div>
      <div class="card">
        <div class="text-xs text-gray-500">Median time to fix</div>
        <div class="text-2xl font-semibold" x-text="metrics.ttfMedianDays === null ? '–' : (metrics.ttfMedianDays + ' days')"></div>
        <div class="muted mt-1">Measured across vulns that disappeared since first seen</div>
      </div>
      <div class="card">
        <div class="text-xs text-gray-500">Median open age</div>
        <div class="text-2xl font-semibold" x-text="metrics.openAgeMedianDays === null ? '–' : (metrics.openAgeMedianDays + ' days')"></div>
        <div class="muted mt-1">How long current vulns have been present</div>
      </div>
    </section>

    <!-- Top CVEs + Oldest Open -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="card">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">Top CVEs (by severity & count)</div>
          <button class="text-xs underline" @click="applyTopCVE()">Clear filter</button>
        </div>
        <template x-if="!(metrics.topCVEs||[]).length">
          <div class="muted">No CVE IDs found in current data.</div>
        </template>
        <ul class="text-sm space-y-2 max-h-72 overflow-auto">
          <template x-for="cve in (metrics.topCVEs || [])" :key="cve.id">
            <li class="flex items-start justify-between gap-3">
              <div>
                <button class="text-blue-600 underline font-medium" @click="applyTopCVE(cve.id)" x-text="cve.id"></button>
                <div class="muted">
                  <span x-text="`Count: ${cve.count}`"></span>
                  · <span x-text="`Max CVSS: ${cve.maxCVSS ?? '-'}`"></span>
                  · <span x-text="`Datasets: ${cve.datasets.join(', ')}`"></span>
                </div>
              </div>
              <span class="chip bg-gray-100">sev rank: <span x-text="cve.worstSeverityRank"></span></span>
            </li>
          </template>
        </ul>
      </div>

      <div class="card">
        <div class="text-sm font-medium mb-2">Oldest open vulnerabilities</div>
        <template x-if="!(metrics.oldestOpen||[]).length">
          <div class="muted">No data yet.</div>
        </template>
        <ul class="text-sm space-y-2 max-h-72 overflow-auto">
          <template x-for="v in (metrics.oldestOpen || [])" :key="v.key">
            <li>
              <div class="font-medium">
                <span x-text="v.meta?.id || '—'"></span>
                <span class="muted">in</span>
                <span class="chip bg-gray-100" x-text="v.meta?.dataset"></span>
              </div>
              <div class="muted">
                <span x-text="`${v.days} days open`"></span>
                · <span x-text="v.meta?.component"></span>
              </div>
              <button class="text-xs text-blue-600 underline mt-1" @click="q=(v.meta?.id||''); applyFilters(true)">Filter by ID</button>
            </li>
          </template>
        </ul>
      </div>
    </section>

    <!-- Tabs -->
    <div class="mb-3 border-b">
      <nav class="-mb-px flex gap-2">
        <button :class="tab==='vulns' ? activeTab : baseTab" @click="tab='vulns'">Vulnerabilities</button>
        <button :class="tab==='components' ? activeTab : baseTab" @click="tab='components'">Components</button>
        <button :class="tab==='compare' ? activeTab : baseTab" @click="tab='compare'">Compare datasets</button>
      </nav>
    </div>

    <!-- Vulnerabilities -->
    <section x-show="tab==='vulns'" x-cloak>
      <div class="mb-2 text-sm text-gray-600">
        <span x-text="`Showing ${filtered.length} of ${items.length} vulnerabilities`"></span>
      </div>
      <div class="overflow-x-auto bg-white border rounded-2xl shadow-sm">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr class="text-left">
              <th class="px-4 py-3">Severity</th>
              <th class="px-4 py-3">CVSS</th>
              <th class="px-4 py-3">Component</th>
              <th class="px-4 py-3">Version</th>
              <th class="px-4 py-3">License</th>
              <th class="px-4 py-3">Vuln ID</th>
              <th class="px-4 py-3">Dataset</th>
              <th class="px-4 py-3">Links</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in paged" :key="row.dataset + (row.id || row.component || Math.random())">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-2">
                  <span class="px-2 py-1 rounded-lg text-xs font-semibold"
                    :class="badge(row.severity)" x-text="row.severity"></span>
                </td>
                <td class="px-4 py-2" x-text="row.cvss ?? '-'"></td>
                <td class="px-4 py-2">
                  <div class="font-medium" x-text="row.component || '-'"></div>
                  <div class="text-xs text-gray-500 truncate max-w-[28rem]" x-text="row.purl"></div>
                </td>
                <td class="px-4 py-2" x-text="row.version || '-'"></td>
                <td class="px-4 py-2">
                  <template x-for="l in (row.licenses || [])"><span class="mr-1 px-1.5 py-0.5 bg-gray-100 rounded"
                    x-text="l"></span></template>
                </td>
                <td class="px-4 py-2">
                  <div x-text="row.id || '-'"></div>
                  <div class="muted" x-show="row.firstSeen">first seen: <span x-text="new Date(row.firstSeen).toLocaleDateString()"></span></div>
                </td>
                <td class="px-4 py-2">
                  <span class="text-xs px-2 py-1 bg-gray-100 rounded" x-text="row.dataset"></span>
                  <template x-if="row.direct"><span class="ml-1 text-[10px] px-1 py-0.5 bg-emerald-100 text-emerald-700 rounded">direct</span></template>
                </td>
                <td class="px-4 py-2">
                  <template x-for="(u, i) in (row.urls || [])">
                    <a class="text-blue-600 underline mr-2" :href="u" target="_blank" x-text="`ref${i+1}`"></a>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          Page <span x-text="page+1"></span> / <span x-text="pages"></span>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 border rounded-lg" :disabled="page===0" @click="prev()">Prev</button>
          <button class="px-3 py-1 border rounded-lg" :disabled="page+1>=pages" @click="next()">Next</button>
        </div>
      </div>
    </section>

    <!-- Components -->
    <section x-show="tab==='components'" x-cloak>
      <div class="mb-2 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <span x-text="`Showing ${grouped.length} components`"></span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <label>Sort:</label>
          <select x-model="compSortKey" @change="applyGroup" class="px-2 py-1 border rounded-lg">
            <option value="vulnCount">Vuln Count</option>
            <option value="worstSeverityRank">Worst Severity</option>
            <option value="maxCVSS">Max CVSS</option>
            <option value="component">Component</option>
          </select>
          <button class="px-2 py-1 border rounded-lg" @click="compSortDir = compSortDir==='desc'?'asc':'desc'; applyGroup()"
                  x-text="compSortDir==='desc' ? '↓' : '↑'"></button>
        </div>
      </div>

      <div class="overflow-x-auto bg-white border rounded-2xl shadow-sm">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr class="text-left">
              <th class="px-4 py-3">Component</th>
              <th class="px-4 py-3">Worst Severity</th>
              <th class="px-4 py-3">Max CVSS</th>
              <th class="px-4 py-3">Vuln Count</th>
              <th class="px-4 py-3">Datasets</th>
              <th class="px-4 py-3">Licenses</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="g in groupedPaged" :key="g.key">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-2">
                  <div class="font-medium" x-text="g.component || '-'"></div>
                  <div class="text-xs text-gray-500 truncate max-w-[28rem]" x-text="g.purlSample"></div>
                </td>
                <td class="px-4 py-2">
                  <span class="px-2 py-1 rounded-lg text-xs font-semibold" :class="badge(g.worstSeverity)" x-text="g.worstSeverity"></span>
                </td>
                <td class="px-4 py-2" x-text="g.maxCVSS ?? '-'"></td>
                <td class="px-4 py-2" x-text="g.vulnCount"></td>
                <td class="px-4 py-2">
                  <template x-for="d in g.datasets"><span class="mr-1 chip bg-gray-100" x-text="d"></span></template>
                </td>
                <td class="px-4 py-2">
                  <template x-for="l in g.licenses"><span class="mr-1 chip bg-gray-100" x-text="l"></span></template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          Page <span x-text="compPage+1"></span> / <span x-text="compPages"></span>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-1 border rounded-lg" :disabled="compPage===0" @click="compPrev()">Prev</button>
          <button class="px-3 py-1 border rounded-lg" :disabled="compPage+1>=compPages" @click="compNext()">Next</button>
        </div>
      </div>
    </section>

    <!-- Compare datasets -->
    <section x-show="tab==='compare'" x-cloak>
      <div class="card mb-4 flex flex-wrap items-center gap-3">
        <div class="text-sm">Compare</div>
        <select x-model="cmpA" @change="buildCompare" class="px-3 py-2 border rounded-xl">
          <option value="">Pick Dataset A</option>
          <template x-for="d in datasets" :key="d.id"><option :value="d.id" x-text="d.id"></option></template>
        </select>
        <span class="text-sm">vs</span>
        <select x-model="cmpB" @change="buildCompare" class="px-3 py-2 border rounded-xl">
          <option value="">Pick Dataset B</option>
          <template x-for="d in datasets" :key="d.id"><option :value="d.id" x-text="d.id"></option></template>
        </select>
      </div>

      <template x-if="cmpReady">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="card">
            <div class="font-medium mb-2" x-text="cmpA"></div>
            <div class="text-sm">Total: <span x-text="cmpStats.A.total"></span></div>
            <ul class="mt-2 text-sm">
              <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO']" :key="s">
                <li><span x-text="s"></span>: <span x-text="cmpStats.A.sev[s] || 0"></span></li>
              </template>
            </ul>
          </div>
          <div class="card">
            <div class="font-medium mb-2" x-text="cmpB"></div>
            <div class="text-sm">Total: <span x-text="cmpStats.B.total"></span></div>
            <ul class="mt-2 text-sm">
              <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO']" :key="s">
                <li><span x-text="s"></span>: <span x-text="cmpStats.B.sev[s] || 0"></span></li>
              </template>
            </ul>
          </div>
          <div class="card">
            <div class="font-medium mb-2">Delta (B − A)</div>
            <div class="text-sm">Total: <span x-text="cmpStats.delta.total"></span></div>
            <ul class="mt-2 text-sm">
              <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO']" :key="s">
                <li><span x-text="s"></span>: <span :class="cmpStats.delta.sev[s]>0?'text-red-600':(cmpStats.delta.sev[s]<0?'text-emerald-600':'')" x-text="cmpStats.delta.sev[s]"></span></li>
              </template>
            </ul>
          </div>
        </div>
      </template>

      <template x-if="cmpReady">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
          <div class="card">
            <div class="font-medium mb-2">Only in <span x-text="cmpA"></span></div>
            <ul class="max-h-72 overflow-auto text-sm list-disc pl-5">
              <template x-for="id in cmpStats.onlyA" :key="id"><li x-text="id"></li></template>
            </ul>
          </div>
          <div class="card">
            <div class="font-medium mb-2">Only in <span x-text="cmpB"></span></div>
            <ul class="max-h-72 overflow-auto text-sm list-disc pl-5">
              <template x-for="id in cmpStats.onlyB" :key="id"><li x-text="id"></li></template>
            </ul>
          </div>
        </div>
      </template>
    </section>
  </main>

  <script>
    function app(){
      return {
        // data
        items: [],
        filtered: [],
        paged: [],
        datasets: [],
        overall: { total: 0, severityCounts: {}, delta: null, severityDelta: {} },
        history: { entries: [] },
        metrics: { fixAvailabilityRate:0, ttfMedianDays:null, openAgeMedianDays:null, oldestOpen:[], topCVEs:[] },

        // filters
        dataset: "",
        q: "",
        severity: "",
        fix: "",
        cvssMin: 0,
        onlyDirect: false,

        // sorting/paging (vulns)
        sortKey: "severityRank",
        sortDir: "desc",
        page: 0,
        perPage: 50,
        pages: 0,

        // components tab
        tab: "vulns",
        grouped: [],
        groupedPaged: [],
        compSortKey: "vulnCount",
        compSortDir: "desc",
        compPage: 0,
        compPerPage: 50,
        compPages: 0,

        // compare
        cmpA: "",
        cmpB: "",
        cmpReady: false,
        cmpStats: { A:{total:0,sev:{}}, B:{total:0,sev:{}}, delta:{total:0,sev:{}}, onlyA:[], onlyB:[] },

        // charts
        donutChart: null,
        sparks: {},

        metaText: "",
        baseTab: "px-3 py-2 text-sm border-b-2 border-transparent text-gray-500",
        activeTab: "px-3 py-2 text-sm border-b-2 border-blue-600 text-blue-700",

        async init(){
          const snap = await fetch("./public/sbom-index.json?_=" + Date.now()).then(r => r.json());
          this.items = snap.items || [];
          this.datasets = (snap.datasets || []).sort((a,b)=>a.id.localeCompare(b.id));
          this.overall = snap.overall || this.overall;
          this.metrics = snap.metrics || this.metrics;
          this.metaText = `updated ${new Date(snap.generatedAt).toLocaleString()}`;

          try { this.history = await fetch("./public/history.json?_=" + Date.now()).then(r => r.json()); }
          catch { this.history = { entries: [] }; }

          this.restoreFromHash();
          this.applyFilters(true);
          this.drawDonut();
          this.drawSparklines();
        },

        // visuals
        badge(sev){
          const s = (sev||"").toUpperCase();
          const base = "px-2 py-0.5 rounded-lg text-xs font-semibold";
          if (s==="CRITICAL") return base+" bg-red-600 text-white";
          if (s==="HIGH") return base+" bg-red-200 text-red-800";
          if (s==="MEDIUM") return base+" bg-amber-100 text-amber-800";
          if (s==="LOW") return base+" bg-green-100 text-green-800";
          return base+" bg-gray-100 text-gray-800";
        },
        deltaBadge(d){
          if (d === null || d === undefined) return '<span class="text-gray-400">–</span>';
          if (d > 0) return `<span class="text-red-600">▲ +${d}</span>`;
          if (d < 0) return `<span class="text-emerald-600">▼ ${d}</span>`;
          return '<span class="text-gray-600">0</span>';
        },

        // filtering/sorting
        applyFilters(buildGroup=false){
          const q = this.q.trim().toLowerCase();
          const sev = this.severity;
          const fix = this.fix;
          const cv = Number(this.cvssMin) || 0;
          const ds = this.dataset;

          this.filtered = this.items.filter(r => {
            if (ds && r.dataset !== ds) return false;
            if (sev && (r.severity||"").toUpperCase() !== sev) return false;
            if (this.onlyDirect && !r.direct) return false;
            if (cv && (r.cvss ?? -1) < cv) return false;
            if (fix === "has" && !(r.fixedVersions || []).length) return false;
            if (fix === "none" && (r.fixedVersions || []).length) return false;
            if (q) {
              const t = [r.component, r.purl, r.id, (r.licenses||[]).join(" "), (r.dataset||"")].join(" ").toLowerCase();
              if (!t.includes(q)) return false;
            }
            return true;
          });

          const key = this.sortKey;
          const dir = this.sortDir === "desc" ? -1 : 1;
          this.filtered.sort((a,b)=>{
            const A = (a[key] ?? "");
            const B = (b[key] ?? "");
            if (typeof A === "number" && typeof B === "number") return (A-B)*dir;
            return String(A).localeCompare(String(B)) * dir;
          });

          this.page = 0;
          this.paginate();
          this.persistToHash();

          if (buildGroup) this.buildGrouped();
          else this.applyGroup();
        },
        paginate(){
          this.pages = Math.max(1, Math.ceil(this.filtered.length / this.perPage));
          const start = this.page * this.perPage;
          this.paged = this.filtered.slice(start, start + this.perPage);
        },
        next(){ if (this.page+1 < this.pages){ this.page++; this.paginate(); this.persistToHash(); } },
        prev(){ if (this.page>0){ this.page--; this.paginate(); this.persistToHash(); } },

        // CSV export of current filtered rows
        exportCSV(){
          const rows = this.filtered;
          if (!rows.length) { alert("No rows to export."); return; }
          const header = ["severity","cvss","component","version","purl","licenses","id","dataset","links","firstSeen"];
          const lines = [header.join(",")];
          for (const r of rows) {
            const csv = [
              r.severity ?? "",
              r.cvss ?? "",
              r.component ?? "",
              r.version ?? "",
              r.purl ?? "",
              (r.licenses||[]).join("|"),
              r.id ?? "",
              r.dataset ?? "",
              (r.urls||[]).join("|"),
              r.firstSeen ?? ""
            ].map(x => `"${String(x).replace(/"/g,'""')}"`).join(",");
            lines.push(csv);
          }
          const blob = new Blob([lines.join("\n")], {type: "text/csv;charset=utf-8;"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "sbom-filtered.csv";
          a.click();
          URL.revokeObjectURL(url);
        },

        // Group-by Components
        buildGrouped(){
          const byKey = new Map();
          for (const r of this.filtered) {
            const key = (r.component || "unknown").toLowerCase();
            const g = byKey.get(key) || {
              key, component: r.component || "unknown", purlSample: r.purl || "",
              datasets: new Set(), licenses: new Set(),
              vulnCount: 0, worstSeverity: "UNKNOWN", worstSeverityRank: -1, maxCVSS: null
            };
            g.datasets.add(r.dataset);
            (r.licenses||[]).forEach(l => g.licenses.add(l));
            g.vulnCount += 1;
            if ((r.severityRank ?? -1) > g.worstSeverityRank){
              g.worstSeverityRank = r.severityRank ?? -1;
              g.worstSeverity = (r.severity || "UNKNOWN").toUpperCase();
            }
            if (r.cvss != null) g.maxCVSS = Math.max(g.maxCVSS ?? -Infinity, r.cvss);
            if (!g.purlSample && r.purl) g.purlSample = r.purl;
            byKey.set(key, g);
          }
          this.grouped = Array.from(byKey.values()).map(g => ({
            ...g,
            datasets: Array.from(g.datasets).sort(),
            licenses: Array.from(g.licenses).sort()
          }));
          this.applyGroup();
        },
        applyGroup(){
          const key = this.compSortKey;
          const dir = this.compSortDir === "desc" ? -1 : 1;
          this.grouped.sort((a,b)=>{
            const A = (a[key] ?? "");
            const B = (b[key] ?? "");
            if (typeof A === "number" && typeof B === "number") return (A-B)*dir;
            return String(A).localeCompare(String(B)) * dir;
          });
          this.compPage = 0;
          this.groupPaginate();
        },
        groupPaginate(){
          this.compPages = Math.max(1, Math.ceil(this.grouped.length / this.compPerPage));
          const start = this.compPage * this.compPerPage;
          this.groupedPaged = this.grouped.slice(start, start + this.compPerPage);
        },
        compNext(){ if (this.compPage+1 < this.compPages){ this.compPage++; this.groupPaginate(); } },
        compPrev(){ if (this.compPage>0){ this.compPage--; this.groupPaginate(); } },

        // Compare datasets
        buildCompare(){
          this.cmpReady = false;
          if (!this.cmpA || !this.cmpB || this.cmpA===this.cmpB) return;
          const A = this.items.filter(x => x.dataset===this.cmpA);
          const B = this.items.filter(x => x.dataset===this.cmpB);
          const sevCount = list => list.reduce((acc,r)=>{const s=(r.severity||"UNKNOWN").toUpperCase(); acc[s]=(acc[s]||0)+1; return acc;},{});
          const ids = list => new Set(list.map(r => r.id || `${r.component}@${r.version||''}`));
          const setA = ids(A), setB = ids(B);
          const onlyA = [...setA].filter(x => !setB.has(x)).slice(0,500);
          const onlyB = [...setB].filter(x => !setA.has(x)).slice(0,500);
          const sevA = sevCount(A), sevB = sevCount(B);
          const deltaSev = {};
          for (const s of ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN']) deltaSev[s] = (sevB[s]||0)-(sevA[s]||0);
          this.cmpStats = {
            A: { total: A.length, sev: sevA },
            B: { total: B.length, sev: sevB },
            delta: { total: B.length - A.length, sev: deltaSev },
            onlyA, onlyB
          };
          this.cmpReady = true;
        },

        // Top CVE helper
        applyTopCVE(id){
          this.q = id || "";
          this.applyFilters(true);
        },

        // Charts
        drawDonut(){
          const ctx = document.getElementById("donut");
          if (!ctx) return;
          const sev = this.overall.severityCounts || {};
          const labels = ['CRITICAL','HIGH','MEDIUM','LOW','INFO'];
          const data = labels.map(k => sev[k] || 0);
          if (this.donutChart) this.donutChart.destroy();
          this.donutChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data }] },
            options: { plugins: { legend: { position: 'bottom' } }, cutout: '65%' }
          });
        },
        drawSparklines(){
          const entries = (this.history.entries || []).slice(-24); // last 24 points
          const labels = entries.map(e => new Date(e.generatedAt).toLocaleDateString());
          const total = entries.map(e => e.overall?.total || 0);
          this.makeSpark('sparkTotal', labels, total);
          for (const k of ['CRITICAL','HIGH','MEDIUM','LOW']) {
            const arr = entries.map(e => e.overall?.severityCounts?.[k] || 0);
            this.makeSpark(`spark-${k}`, labels, arr);
          }
        },
        makeSpark(id, labels, data){
          const el = document.getElementById(id);
          if (!el) return;
          if (this.sparks[id]) this.sparks[id].destroy();
          this.sparks[id] = new Chart(el, {
            type: 'line',
            data: { labels, datasets: [{ data, tension: 0.3, pointRadius: 0, borderWidth: 2 }] },
            options: {
              responsive: true,
              plugins: { legend: { display: false }, tooltip: { enabled: true } },
              scales: { x: { display: false }, y: { display: false } },
              elements: { line: { fill: false } }
            }
          });
        },

        // save/load view (localStorage)
        saveView(){
          const s = {
            q:this.q, dataset:this.dataset, severity:this.severity, fix:this.fix,
            cvssMin:this.cvssMin, onlyDirect:this.onlyDirect,
            sortKey:this.sortKey, sortDir:this.sortDir, tab:this.tab
          };
          localStorage.setItem("sbom_view", JSON.stringify(s));
          alert("View saved.");
        },
        loadView(){
          const s = JSON.parse(localStorage.getItem("sbom_view") || "null");
          if (!s) { alert("No saved view."); return; }
          Object.assign(this, s);
          this.applyFilters(true);
        },

        // state in URL
        persistToHash(){
          const h = new URLSearchParams({
            tab: this.tab,
            q: this.q || "", ds: this.dataset || "", sev: this.severity || "",
            fix: this.fix || "", cvss: String(this.cvssMin || 0),
            dir: this.sortDir, key: this.sortKey, dirc: this.onlyDirect ? "1" : "0",
            p: String(this.page),
            cdir: this.compSortDir, ckey: this.compSortKey, cp: String(this.compPage),
            cmpA: this.cmpA || "", cmpB: this.cmpB || ""
          }).toString();
          location.hash = h;
        },
        restoreFromHash(){
          const s = new URLSearchParams(location.hash.replace(/^#/, ""));
          this.tab = s.get("tab") || this.tab;
          this.q = s.get("q") || this.q;
          this.dataset = s.get("ds") || this.dataset;
          this.severity = s.get("sev") || this.severity;
          this.fix = s.get("fix") || this.fix;
          this.cvssMin = Number(s.get("cvss") || this.cvssMin || 0);
          this.sortDir = s.get("dir") || this.sortDir;
          this.sortKey = s.get("key") || this.sortKey;
          this.onlyDirect = s.get("dirc")==="1" ? true : this.onlyDirect;
          this.page = Number(s.get("p") || this.page || 0);
          this.compSortDir = s.get("cdir") || this.compSortDir;
          this.compSortKey = s.get("ckey") || this.compSortKey;
          this.compPage = Number(s.get("cp") || this.compPage || 0);
          this.cmpA = s.get("cmpA") || this.cmpA;
          this.cmpB = s.get("cmpB") || this.cmpB;
          if (this.cmpA && this.cmpB && this.cmpA !== this.cmpB) this.buildCompare();
        }
      }
    }
  </script>
</body>
</html> -->


<!doctype html>
<html lang="en" x-data="app()" x-init="init()" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBOM Explorer</title>
  <!-- Alpine + Chart.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    /* simple, buildless CSS  */
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:#f9fafb; color:#111827; }
    .container{ max-width:1120px; margin:0 auto; padding:0 1rem; }
    .toolbar{ position:sticky; top:0; z-index:40; background:rgba(255,255,255,.9); backdrop-filter:saturate(180%) blur(6px); border-bottom:1px solid #e5e7eb; }
    .row{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    input, select, button{ font:inherit; }
    input, select{ border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; background:#fff; }
    button{ border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; background:#fff; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .card{
      background:#fff; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); padding:1rem;
    }
    .chip{ font-size:.75rem; padding:.125rem .5rem; border-radius:.375rem; background:#f3f4f6; }
    [x-cloak]{ display:none !important; }
    .muted{ font-size:.75rem; color:#6b7280; }
    .grid{ display:grid; gap:1rem; }
    .grid-auto-rows{ grid-auto-rows:minmax(0,1fr); }
    .grid-12{ grid-template-columns: repeat(12,minmax(0,1fr)); }
    .lg7{ grid-column: span 12; } .lg5{ grid-column: span 12; }
    @media (min-width:1024px){ .lg7{ grid-column: span 7; } .lg5{ grid-column: span 5; } }
    .cols-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    @media (min-width:768px){ .md-cols-4{ grid-template-columns:repeat(4,minmax(0,1fr)); } }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:.5rem 1rem; text-align:left; }
    thead{ background:#f9fafb; }
    tr + tr{ border-top:1px solid #e5e7eb; }
  </style>
</head>
<body class="h-full">
  <header class="toolbar">
    <div class="container" style="padding:.75rem 1rem;">
      <div class="row" style="gap:.75rem;">
        <h1 style="font-weight:600; font-size:1.25rem;">SBOM Explorer</h1>
        <span class="muted" x-text="metaText"></span>
        <div style="margin-left:auto;" class="row">
          <button @click="exportCSV()">Export CSV</button>
          <button @click="saveView()">Save View</button>
          <button @click="loadView()">Load View</button>
        </div>
      </div>
      <div class="row" style="padding:.5rem 0 .75rem; gap:.5rem;">
        <input x-model="q" @input="applyFilters(true)" placeholder="Search (component, purl, vuln id, license)" style="width:18rem;" />
        <select x-model="dataset" @change="applyFilters(true)">
          <option value="">All datasets</option>
          <template x-for="d in datasets" :key="d.id">
            <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
          </template>
        </select>
        <select x-model="severity" @change="applyFilters(true)">
          <option value="">All severities</option>
          <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN']" :key="s">
            <option :value="s" x-text="s"></option>
          </template>
        </select>
        <select x-model="fix" @change="applyFilters(true)">
          <option value="">Fix status</option>
          <option value="has">Has fix</option>
          <option value="none">No fix</option>
        </select>
        <label class="row" style="border:1px solid #e5e7eb; border-radius:.75rem; padding:.25rem .5rem;">
          <span class="muted" style="font-size:.875rem;">CVSS ≥</span>
          <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin" @input="applyFilters(true)" style="width:5rem; border:0; outline:none;"/>
        </label>
        <label class="row" style="border:1px solid #e5e7eb; border-radius:.75rem; padding:.25rem .5rem;">
          <input type="checkbox" x-model="onlyDirect" @change="applyFilters(true)" />
          <span class="muted" style="font-size:.875rem;">Only direct</span>
        </label>
        <div class="row" style="margin-left:auto;">
          <span class="muted">Sort:</span>
          <select x-model="sortKey" @change="applyFilters()">
            <option value="severityRank">Severity</option>
            <option value="cvss">CVSS</option>
            <option value="component">Component</option>
            <option value="dataset">Dataset</option>
          </select>
          <button @click="sortDir = sortDir==='desc'?'asc':'desc'; applyFilters()" x-text="sortDir==='desc' ? '↓' : '↑'"></button>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding:1.5rem 1rem;">
    <!-- Summary -->
    <section class="grid grid-12">
      <div class="lg7 grid cols-2 md-cols-4">
        <div class="card" style="grid-column: span 2;">
          <div class="muted">Total Vulnerabilities</div>
          <div style="font-size:1.5rem; font-weight:600;" x-text="overall.total"></div>
          <div class="muted" x-html="deltaBadge(overall.delta)"></div>
          <canvas id="sparkTotal" height="40" style="margin-top:.5rem;"></canvas>
        </div>
        <template x-for="sev in ['CRITICAL','HIGH','MEDIUM','LOW']" :key="sev">
          <div class="card">
            <div class="muted" x-text="sev"></div>
            <div style="font-size:1.25rem; font-weight:600;" x-text="overall.severityCounts[sev] ?? 0"></div>
            <div class="muted" x-html="deltaBadge(overall.severityDelta[sev])"></div>
            <canvas :id="`spark-${sev}`" height="40" style="margin-top:.5rem;"></canvas>
          </div>
        </template>
      </div>
      <div class="card lg5">
        <div style="font-weight:500; margin-bottom:.5rem;">Severity distribution</div>
        <canvas id="donut" height="160"></canvas>
      </div>
    </section>

    <!-- Metrics -->
    <section class="grid cols-2" style="margin-top:1rem;">
      <div class="card">
        <div class="muted">Fix availability rate</div>
        <div style="font-size:1.5rem; font-weight:600;" x-text="(metrics.fixAvailabilityRate||0) + '%'"></div>
        <div class="muted">％ of current vulns with known fixes</div>
      </div>
      <div class="card">
        <div class="muted">Median time to fix</div>
        <div style="font-size:1.5rem; font-weight:600;" x-text="metrics.ttfMedianDays === null ? '–' : (metrics.ttfMedianDays + ' days')"></div>
        <div class="muted">Measured across vulns that disappeared since first seen</div>
      </div>
      <div class="card">
        <div class="muted">Median open age</div>
        <div style="font-size:1.5rem; font-weight:600;" x-text="metrics.openAgeMedianDays === null ? '–' : (metrics.openAgeMedianDays + ' days')"></div>
        <div class="muted">How long current vulns have been present</div>
      </div>
    </section>

    <!-- Top CVEs & Oldest Open -->
    <section class="grid cols-2" style="margin-top:1rem;">
      <div class="card">
        <div class="row" style="justify-content:space-between; margin-bottom:.5rem;">
          <div style="font-weight:500;">Top CVEs (by severity & count)</div>
          <button class="muted" style="text-decoration:underline; font-size:.75rem;" @click="applyTopCVE()">Clear filter</button>
        </div>
        <template x-if="!(metrics.topCVEs||[]).length">
          <div class="muted">No CVE IDs found in current data.</div>
        </template>
        <ul style="font-size:.9rem; max-height:18rem; overflow:auto; padding-left:1rem;">
          <template x-for="cve in (metrics.topCVEs || [])" :key="cve.id">
            <li class="row" style="justify-content:space-between; align-items:flex-start; margin:.25rem 0;">
              <div>
                <button style="color:#2563eb; text-decoration:underline; font-weight:600;" @click="applyTopCVE(cve.id)" x-text="cve.id"></button>
                <div class="muted">
                  <span x-text="`Count: ${cve.count}`"></span>
                  · <span x-text="`Max CVSS: ${cve.maxCVSS ?? '-'}`"></span>
                  · <span x-text="`Datasets: ${cve.datasets.join(', ')}`"></span>
                </div>
              </div>
              <span class="chip">sev rank: <span x-text="cve.worstSeverityRank"></span></span>
            </li>
          </template>
        </ul>
      </div>
      <div class="card">
        <div style="font-weight:500; margin-bottom:.5rem;">Oldest open vulnerabilities</div>
        <template x-if="!(metrics.oldestOpen||[]).length">
          <div class="muted">No data yet.</div>
        </template>
        <ul style="font-size:.9rem; max-height:18rem; overflow:auto;">
          <template x-for="v in (metrics.oldestOpen || [])" :key="v.key">
            <li style="margin:.25rem 0;">
              <div style="font-weight:600;">
                <span x-text="v.meta?.id || '—'"></span>
                <span class="muted">in</span>
                <span class="chip" x-text="v.meta?.dataset"></span>
              </div>
              <div class="muted"><span x-text="`${v.days} days open`"></span> · <span x-text="v.meta?.component"></span></div>
              <button class="muted" style="text-decoration:underline; font-size:.75rem;" @click="q=(v.meta?.id||''); applyFilters(true)">Filter by ID</button>
            </li>
          </template>
        </ul>
      </div>
    </section>

    <!-- Tabs -->
    <div style="margin-top:1rem; border-bottom:1px solid #e5e7eb;">
      <nav class="row" style="gap:.5rem;">
        <button :class="tab==='vulns' ? 'muted' : ''" style="border-bottom:2px solid" @click="tab='vulns'">Vulnerabilities</button>
        <button :class="tab==='components' ? 'muted' : ''" style="border-bottom:2px solid" @click="tab='components'">Components</button>
        <button :class="tab==='compare' ? 'muted' : ''" style="border-bottom:2px solid" @click="tab='compare'">Compare datasets</button>
      </nav>
    </div>

    <!-- Vulnerabilities -->
    <section x-show="tab==='vulns'" x-cloak>
      <div class="muted" style="margin:.5rem 0;">
        <span x-text="`Showing ${filtered.length} of ${items.length} vulnerabilities`"></span>
      </div>
      <div class="card" style="padding:0;">
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Severity</th><th>CVSS</th><th>Component</th><th>Version</th><th>License</th><th>Vuln ID</th><th>Dataset</th><th>Links</th>
              </tr>
            </thead>
            <tbody>
            <template x-for="row in paged" :key="row.dataset + (row.id || row.component || Math.random())">
              <tr>
                <td><span :style="badge(row.severity)" x-text="row.severity"></span></td>
                <td x-text="row.cvss ?? '-'"></td>
                <td>
                  <div style="font-weight:600;" x-text="row.component || '-'"></div>
                  <div class="muted" style="max-width:28rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" x-text="row.purl"></div>
                </td>
                <td x-text="row.version || '-'"></td>
                <td>
                  <template x-for="l in (row.licenses || [])"><span class="chip" style="margin-right:.25rem;" x-text="l"></span></template>
                </td>
                <td>
                  <div x-text="row.id || '-'"></div>
                  <div class="muted" x-show="row.firstSeen">first seen: <span x-text="new Date(row.firstSeen).toLocaleDateString()"></span></div>
                </td>
                <td>
                  <span class="chip" x-text="row.dataset"></span>
                  <template x-if="row.direct"><span class="chip" style="background:#d1fae5; color:#065f46; margin-left:.25rem;">direct</span></template>
                </td>
                <td>
                  <template x-for="(u, i) in (row.urls || [])">
                    <a style="color:#2563eb; text-decoration:underline; margin-right:.5rem;" :href="u" target="_blank" x-text="`ref${i+1}`"></a>
                  </template>
                </td>
              </tr>
            </template>
            </tbody>
          </table>
        </div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:.75rem;">
        <div class="muted">Page <span x-text="page+1"></span> / <span x-text="pages"></span></div>
        <div class="row">
          <button :disabled="page===0" @click="prev()">Prev</button>
          <button :disabled="page+1>=pages" @click="next()">Next</button>
        </div>
      </div>
    </section>

    <!-- Components -->
    <section x-show="tab==='components'" x-cloak>
      <div class="row" style="justify-content:space-between; margin:.5rem 0;">
        <div class="muted"><span x-text="`Showing ${grouped.length} components`"></span></div>
        <div class="row">
          <span class="muted">Sort:</span>
          <select x-model="compSortKey" @change="applyGroup">
            <option value="vulnCount">Vuln Count</option>
            <option value="worstSeverityRank">Worst Severity</option>
            <option value="maxCVSS">Max CVSS</option>
            <option value="component">Component</option>
          </select>
          <button @click="compSortDir = compSortDir==='desc'?'asc':'desc'; applyGroup()" x-text="compSortDir==='desc' ? '↓' : '↑'"></button>
        </div>
      </div>
      <div class="card" style="padding:0;">
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Component</th><th>Worst Severity</th><th>Max CVSS</th><th>Vuln Count</th><th>Datasets</th><th>Licenses</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="g in groupedPaged" :key="g.key">
                <tr>
                  <td>
                    <div style="font-weight:600;" x-text="g.component || '-'"></div>
                    <div class="muted" style="max-width:28rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" x-text="g.purlSample"></div>
                  </td>
                  <td><span :style="badge(g.worstSeverity)" x-text="g.worstSeverity"></span></td>
                  <td x-text="g.maxCVSS ?? '-'"></td>
                  <td x-text="g.vulnCount"></td>
                  <td><template x-for="d in g.datasets"><span class="chip" style="margin-right:.25rem;" x-text="d"></span></template></td>
                  <td><template x-for="l in g.licenses"><span class="chip" style="margin-right:.25rem;" x-text="l"></span></template></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:.75rem;">
        <div class="muted">Page <span x-text="compPage+1"></span> / <span x-text="compPages"></span></div>
        <div class="row">
          <button :disabled="compPage===0" @click="compPrev()">Prev</button>
          <button :disabled="compPage+1>=compPages" @click="compNext()">Next</button>
        </div>
      </div>
    </section>

    <!-- Compare -->
    <section x-show="tab==='compare'" x-cloak>
      <div class="card row" style="flex-wrap:wrap; gap:.75rem; margin-bottom:1rem;">
        <div class="muted">Compare</div>
        <select x-model="cmpA" @change="buildCompare"><option value="">Pick Dataset A</option><template x-for="d in datasets" :key="d.id"><option :value="d.id" x-text="d.id"></option></template></select>
        <span class="muted">vs</span>
        <select x-model="cmpB" @change="buildCompare"><option value="">Pick Dataset B</option><template x-for="d in datasets" :key="d.id"><option :value="d.id" x-text="d.id"></option></template></select>
      </div>

      <template x-if="cmpReady">
        <div class="grid grid-auto-rows" style="grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem;">
          <div class="card">
            <div style="font-weight:600; margin-bottom:.5rem;" x-text="cmpA"></div>
            <div class="muted">Total: <span x-text="cmpStats.A.total"></span></div>
            <ul style="margin:.5rem 0 0; font-size:.9rem;">
              <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO']" :key="s">
                <li><span x-text="s"></span>: <span x-text="cmpStats.A.sev[s] || 0"></span></li>
              </template>
            </ul>
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.5rem;" x-text="cmpB"></div>
            <div class="muted">Total: <span x-text="cmpStats.B.total"></span></div>
            <ul style="margin:.5rem 0 0; font-size:.9rem;">
              <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO']" :key="s">
                <li><span x-text="s"></span>: <span x-text="cmpStats.B.sev[s] || 0"></span></li>
              </template>
            </ul>
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.5rem;">Delta (B − A)</div>
            <div class="muted">Total: <span x-text="cmpStats.delta.total"></span></div>
            <ul style="margin:.5rem 0 0; font-size:.9rem;">
              <template x-for="s in ['CRITICAL','HIGH','MEDIUM','LOW','INFO']" :key="s">
                <li>
                  <span x-text="s"></span>:
                  <span :style="(cmpStats.delta.sev[s]>0?'color:#dc2626':(cmpStats.delta.sev[s]<0?'color:#059669':''))"
                        x-text="cmpStats.delta.sev[s]"></span>
                </li>
              </template>
            </ul>
          </div>
        </div>
      </template>

      <template x-if="cmpReady">
        <div class="grid grid-auto-rows" style="grid-template-columns:repeat(1,minmax(0,1fr)); gap:1rem; margin-top:1rem;">
          <div class="card">
            <div style="font-weight:600; margin-bottom:.5rem;">Only in <span x-text="cmpA"></span></div>
            <ul style="max-height:18rem; overflow:auto; font-size:.9rem; padding-left:1.2rem; list-style:disc;">
              <template x-for="id in cmpStats.onlyA" :key="id"><li x-text="id"></li></template>
            </ul>
          </div>
          <div class="card">
            <div style="font-weight:600; margin-bottom:.5rem;">Only in <span x-text="cmpB"></span></div>
            <ul style="max-height:18rem; overflow:auto; font-size:.9rem; padding-left:1.2rem; list-style:disc;">
              <template x-for="id in cmpStats.onlyB" :key="id"><li x-text="id"></li></template>
            </ul>
          </div>
        </div>
      </template>
    </section>
  </main>

  <!-- Optimized app script (fast filters, instant charts) -->
  <script>
    const debounce = (fn, ms=80) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    function app(){
      return {
        items: [], _tokens: [], filtered: [], paged: [],
        datasets: [], overall:{ total:0, severityCounts:{}, delta:null, severityDelta:{} },
        history:{ entries:[] }, metrics:{ fixAvailabilityRate:0, ttfMedianDays:null, openAgeMedianDays:null, oldestOpen:[], topCVEs:[] },

        dataset:"", q:"", severity:"", fix:"", cvssMin:0, onlyDirect:false,
        sortKey:"severityRank", sortDir:"desc", page:0, perPage:50, pages:0,
        tab:"vulns",
        grouped:[], groupedPaged:[], compSortKey:"vulnCount", compSortDir:"desc", compPage:0, compPerPage:50, compPages:0,
        cmpA:"", cmpB:"", cmpReady:false, cmpStats:{ A:{total:0,sev:{}}, B:{total:0,sev:{}}, delta:{total:0,sev:{}}, onlyA:[], onlyB:[] },
        donutChart:null, sparks:{}, metaText:"",

        _debouncedApply:null, _debouncedPersist:null,

        async init(){
          const snap = await fetch("./public/sbom-index.json?_="+Date.now()).then(r=>r.json());
          this.items = (snap.items||[]).map(r=>({
            ...r,
            cvss: r.cvss ?? null,
            severityRank: r.severityRank ?? ({CRITICAL:4,HIGH:3,MEDIUM:2,LOW:1}[String(r.severity).toUpperCase()]||0)
          }));
          this._tokens = this.items.map(r => [r.component,r.purl,r.id,(r.licenses||[]).join(" "),r.dataset||""].join(" ").toLowerCase());
          this.datasets = (snap.datasets||[]).sort((a,b)=>a.id.localeCompare(b.id));
          this.overall  = snap.overall || this.overall;
          this.metrics  = snap.metrics || this.metrics;
          this.metaText = `updated ${new Date(snap.generatedAt).toLocaleString()}`;

          try{ this.history = await fetch("./public/history.json?_="+Date.now()).then(r=>r.json()); }
          catch{ this.history = { entries:[] }; }

          this._debouncedApply = debounce((build)=>this._applyCore(build), 50);
          this._debouncedPersist = debounce(()=>this._persistToHash(), 80);

          this.restoreFromHash();
          this._applyCore(true);
          this.drawDonut();
          this.drawSparklines();
        },

        badge(sev){
          const s = (sev||"").toUpperCase();
          const base = "display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem;font-weight:600;";
          if (s==="CRITICAL") return base+"background:#dc2626;color:#fff";
          if (s==="HIGH")     return base+"background:#fecaca;color:#7f1d1d";
          if (s==="MEDIUM")   return base+"background:#fde68a;color:#92400e";
          if (s==="LOW")      return base+"background:#d1fae5;color:#065f46";
          return base+"background:#f3f4f6;color:#374151";
        },
        deltaBadge(d){
          if (d==null) return '<span class="muted">–</span>';
          if (d>0) return '<span style="color:#dc2626">▲ +'+d+'</span>';
          if (d<0) return '<span style="color:#059669">▼ '+d+'</span>';
          return '<span class="muted">0</span>';
        },

        applyFilters(build=false){ this._debouncedApply(build); },
        _applyCore(build=false){
          const q=this.q.trim().toLowerCase(), ds=this.dataset, sev=this.severity, fix=this.fix, cv=Number(this.cvssMin)||0;
          this.filtered = [];
          for (let i=0;i<this.items.length;i++){
            const r=this.items[i];
            if (ds && r.dataset!==ds) continue;
            if (sev && (r.severity||"").toUpperCase()!==sev) continue;
            if (this.onlyDirect && !r.direct) continue;
            if (cv && (r.cvss??-1) < cv) continue;
            if (fix==="has" && !(r.fixedVersions||[]).length) continue;
            if (fix==="none" && (r.fixedVersions||[]).length) continue;
            if (q && !this._tokens[i].includes(q)) continue;
            this.filtered.push(r);
          }
          const key=this.sortKey, dir=this.sortDir==="desc"?-1:1;
          this.filtered.sort((a,b)=>{ const A=a[key]??"",B=b[key]??""; return (typeof A==="number"&&typeof B==="number")?(A-B)*dir:String(A).localeCompare(String(B))*dir; });
          const maxPages = Math.max(1, Math.ceil(this.filtered.length/this.perPage));
          this.pages=maxPages; if (this.page>=maxPages) this.page=maxPages-1; if (this.page<0) this.page=0;
          const start=this.page*this.perPage; this.paged=this.filtered.slice(start,start+this.perPage);
          this._debouncedPersist();
          if (build) this.buildGrouped(); else this.applyGroup();
        },
        next(){ if (this.page+1<this.pages){ this.page++; this._applyCore(); } },
        prev(){ if (this.page>0){ this.page--; this._applyCore(); } },

        exportCSV(){
          const rows=this.filtered; if(!rows.length){ alert("No rows to export."); return; }
          const header=["severity","cvss","component","version","purl","licenses","id","dataset","links","firstSeen"];
          const out=[header.join(",")];
          for(const r of rows){
            const line=[r.severity??"",r.cvss??"",r.component??"",r.version??"",r.purl??"", (r.licenses||[]).join("|"), r.id??"", r.dataset??"", (r.urls||[]).join("|"), r.firstSeen??""]
              .map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",");
            out.push(line);
          }
          const blob=new Blob([out.join("\n")],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
          const a=document.createElement("a"); a.href=url; a.download="sbom-filtered.csv"; a.click(); URL.revokeObjectURL(url);
        },

        buildGrouped(){
          const by=new Map();
          for(const r of this.filtered){
            const k=(r.component||"unknown").toLowerCase();
            const g=by.get(k)||{ key:k, component:r.component||"unknown", purlSample:r.purl||"", datasets:new Set(), licenses:new Set(), vulnCount:0, worstSeverity:"UNKNOWN", worstSeverityRank:-1, maxCVSS:null };
            g.datasets.add(r.dataset); (r.licenses||[]).forEach(l=>g.licenses.add(l));
            g.vulnCount++; if((r.severityRank??-1)>g.worstSeverityRank){ g.worstSeverityRank=r.severityRank??-1; g.worstSeverity=(r.severity||"UNKNOWN").toUpperCase(); }
            if(r.cvss!=null) g.maxCVSS=Math.max(g.maxCVSS??-Infinity,r.cvss); if(!g.purlSample&&r.purl) g.purlSample=r.purl; by.set(k,g);
          }
          this.grouped=[...by.values()].map(g=>({...g,datasets:[...g.datasets].sort(),licenses:[...g.licenses].sort()}));
          this.applyGroup();
        },
        applyGroup(){
          const key=this.compSortKey, dir=this.compSortDir==="desc"?-1:1;
          this.grouped.sort((a,b)=>{ const A=a[key]??"",B=b[key]??""; return (typeof A==="number"&&typeof B==="number")?(A-B)*dir:String(A).localeCompare(String(B))*dir; });
          this.compPage=0; this.groupPaginate();
        },
        groupPaginate(){ this.compPages=Math.max(1,Math.ceil(this.grouped.length/this.compPerPage)); const s=this.compPage*this.compPerPage; this.groupedPaged=this.grouped.slice(s,s+this.compPerPage); },
        compNext(){ if(this.compPage+1<this.compPages){ this.compPage++; this.groupPaginate(); } },
        compPrev(){ if(this.compPage>0){ this.compPage--; this.groupPaginate(); } },

        buildCompare(){
          this.cmpReady=false; if(!this.cmpA||!this.cmpB||this.cmpA===this.cmpB) return;
          const A=this.items.filter(x=>x.dataset===this.cmpA), B=this.items.filter(x=>x.dataset===this.cmpB);
          const sevCount=arr=>arr.reduce((acc,r)=>{const s=(r.severity||"UNKNOWN").toUpperCase(); acc[s]=(acc[s]||0)+1; return acc;},{});
          const ids=arr=>new Set(arr.map(r=>r.id || `${r.component}@${r.version||''}`));
          const setA=ids(A), setB=ids(B);
          const onlyA=[...setA].filter(x=>!setB.has(x)).slice(0,500);
          const onlyB=[...setB].filter(x=>!setA.has(x)).slice(0,500);
          const sevA=sevCount(A), sevB=sevCount(B); const deltaSev={}; for(const s of ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN']) deltaSev[s]=(sevB[s]||0)-(sevA[s]||0);
          this.cmpStats={ A:{total:A.length, sev:sevA}, B:{total:B.length, sev:sevB}, delta:{total:B.length-A.length, sev:deltaSev}, onlyA, onlyB };
          this.cmpReady=true;
        },

        applyTopCVE(id){ this.q=id||""; this.applyFilters(true); },

        drawDonut(){
          const el=document.getElementById("donut"); if(!el) return;
          const sev=this.overall.severityCounts||{}; const labels=['CRITICAL','HIGH','MEDIUM','LOW','INFO']; const data=labels.map(k=>sev[k]||0);
          if(!this.donutChart){
            this.donutChart=new Chart(el,{ type:'doughnut', data:{ labels, datasets:[{ data }] }, options:{ animation:false, parsing:false, plugins:{ legend:{ position:'bottom' } }, cutout:'65%' } });
          } else {
            this.donutChart.data.labels=labels; this.donutChart.data.datasets[0].data=data; this.donutChart.update('none');
          }
        },
        drawSparklines(){
          const e=(this.history.entries||[]).slice(-24), labels=e.map(x=>new Date(x.generatedAt).toLocaleDateString());
          this.makeSpark('sparkTotal', labels, e.map(x=>x.overall?.total||0));
          for(const k of ['CRITICAL','HIGH','MEDIUM','LOW']) this.makeSpark(`spark-${k}`, labels, e.map(x=>x.overall?.severityCounts?.[k]||0));
        },
        makeSpark(id, labels, data){
          const el=document.getElementById(id); if(!el) return;
          if(!this.sparks[id]){
            this.sparks[id]=new Chart(el,{ type:'line', data:{ labels, datasets:[{ data, tension:.3, pointRadius:0, borderWidth:2 }] },
              options:{ animation:false, parsing:false, plugins:{ legend:{ display:false }, tooltip:{ enabled:true } }, scales:{ x:{ display:false }, y:{ display:false } }, elements:{ line:{ fill:false } } }});
          } else {
            this.sparks[id].data.labels=labels; this.sparks[id].data.datasets[0].data=data; this.sparks[id].update('none');
          }
        },

        saveView(){ localStorage.setItem("sbom_view", JSON.stringify({ q:this.q,dataset:this.dataset,severity:this.severity,fix:this.fix,cvssMin:this.cvssMin,onlyDirect:this.onlyDirect,sortKey:this.sortKey,sortDir:this.sortDir,tab:this.tab })); alert("View saved."); },
        loadView(){ const s=JSON.parse(localStorage.getItem("sbom_view")||"null"); if(!s){ alert("No saved view."); return; } Object.assign(this,s); this.applyFilters(true); },

        _persistToHash(){
          const h=new URLSearchParams({ tab:this.tab,q:this.q||"",ds:this.dataset||"",sev:this.severity||"",fix:this.fix||"",cvss:String(this.cvssMin||0),dir:this.sortDir,key:this.sortKey,dirc:this.onlyDirect?"1":"0",p:String(this.page),cdir:this.compSortDir,ckey:this.compSortKey,cp:String(this.compPage),cmpA:this.cmpA||"",cmpB:this.cmpB||"" }).toString();
          location.hash=h;
        },
        persistToHash(){ (this._debouncedPersist||(()=>{}))(); },
        restoreFromHash(){
          const s=new URLSearchParams(location.hash.replace(/^#/,""));
          this.tab=s.get("tab")||this.tab; this.q=s.get("q")||this.q; this.dataset=s.get("ds")||this.dataset; this.severity=s.get("sev")||this.severity;
          this.fix=s.get("fix")||this.fix; this.cvssMin=Number(s.get("cvss")||this.cvssMin||0); this.sortDir=s.get("dir")||this.sortDir; this.sortKey=s.get("key")||this.sortKey;
          this.onlyDirect=s.get("dirc")==="1" ? true : this.onlyDirect; this.page=Number(s.get("p")||this.page||0);
          this.compSortDir=s.get("cdir")||this.compSortDir; this.compSortKey=s.get("ckey")||this.compSortKey; this.compPage=Number(s.get("cp")||this.compPage||0);
          this.cmpA=s.get("cmpA")||this.cmpA; this.cmpB=s.get("cmpB")||this.cmpB; if(this.cmpA&&this.cmpB&&this.cmpA!==this.cmpB) this.buildCompare();
        }
      }
    }
  </script>
</body>
</html>
