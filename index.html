<!doctype html>
<html lang="en" x-data="app()" x-init="init()" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBOM Explorer</title>
  <meta name="color-scheme" content="light" />

  <!-- Minimal, fast CDN libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>

  <style>
    .card{ @apply bg-white border rounded-2xl shadow-sm p-4; }
    .chip{ @apply text-xs px-2 py-0.5 rounded; }
    [x-cloak]{ display:none !important; }
    .muted{ @apply text-xs text-gray-500; }
    .skeleton{ @apply animate-pulse bg-gray-200 rounded; }
    a:focus-visible, button:focus-visible, select:focus-visible, input:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
    .bar { @apply h-2 w-full bg-gray-200 rounded; }
    .bar-fill { @apply h-2 rounded; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); }
  </style>
</head>
<body class="h-full">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-semibold">SBOM Explorer</h1>
      <span class="text-xs text-gray-500" x-text="metaText" aria-live="polite"></span>
      <div class="ml-auto flex gap-2">
        <button class="px-3 py-2 border rounded-xl" @click="exportCSV()">Export CSV</button>
        <button class="px-3 py-2 border rounded-xl" @click="saveView()">Save View</button>
        <button class="px-3 py-2 border rounded-xl" @click="loadView()">Load View</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-4 pb-3 flex items-center gap-2 flex-wrap">
      <input x-model="q" @input="applyFilters(true)" placeholder="Search (component, purl, vuln id, license)"
        class="w-72 px-3 py-2 border rounded-xl focus:outline-none focus:ring" />

      <select x-model="dataset" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl">
        <option value="">All datasets</option>
        <template x-for="d in datasets" :key="d._key">
          <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
        </template>
      </select>

      <select x-model="severity" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl">
        <option value="">All severities</option>
        <template x-for="s in sevOrder" :key="s">
          <option :value="s" x-text="s"></option>
        </template>
      </select>

      <select x-model="fix" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl">
        <option value="">Has fix?</option>
        <option value="has">Has fix</option>
        <option value="none">No fix</option>
      </select>

      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <span class="text-sm">CVSS ≥</span>
        <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin" @input="applyFilters(true)" class="w-20 outline-none" />
      </label>

      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <input type="checkbox" x-model="onlyDirect" @change="applyFilters(true)">
        <span class="text-sm">Only direct</span>
      </label>

      <div class="ml-auto flex items-center gap-2 text-sm">
        <label>Sort:</label>
        <select x-model="sortKey" @change="applyFilters()" class="px-2 py-1 border rounded-lg">
          <option value="severityRank">Severity</option>
          <option value="cvss">CVSS</option>
          <option value="component">Component</option>
          <option value="dataset">Dataset</option>
        </select>
        <button class="px-2 py-1 border rounded-lg" @click="sortDir = sortDir==='desc'?'asc':'desc'; applyFilters()"
                x-text="sortDir==='desc' ? '↓' : '↑'"></button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6" x-cloak>
    <!-- Always-on summaries (no charts) -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6" aria-live="polite">
      <div class="lg:col-span-7 grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="card col-span-2">
          <div class="text-xs text-gray-500">Total Vulnerabilities (filtered)</div>
          <div class="text-2xl font-semibold" x-text="filtered.length"></div>
          <div class="muted mt-1" x-text="filterSummary"></div>
        </div>
        <template x-for="sev in ['CRITICAL','HIGH','MEDIUM','LOW']" :key="'sev-'+sev">
          <div class="card">
            <div class="text-xs text-gray-500" x-text="sev"></div>
            <div class="text-xl font-semibold" x-text="sevCountsFiltered[sev] || 0"></div>
            <div class="text-xs mt-1 text-gray-400">filtered</div>
          </div>
        </template>
      </div>

      <!-- Per-dataset compact summary with bar -->
      <div class="card lg:col-span-5">
        <div class="text-sm font-medium mb-3">Datasets (filtered presence)</div>
        <template x-if="Object.keys(perDatasetSev).length === 0">
          <div class="muted">No datasets in the current filter.</div>
        </template>
        <div class="space-y-3 max-h-60 overflow-auto">
          <template x-for="(v, name) in perDatasetSev" :key="'ds-'+name">
            <div>
              <div class="flex items-center justify-between text-sm">
                <div class="font-medium" x-text="name"></div>
                <div class="text-xs text-gray-500" x-text="`${v.total} vulns`"></div>
              </div>
              <div class="bar">
                <div class="bar-fill" :style="`width:${Math.min(100, (v.total/Math.max(1, filtered.length))*100)}%`"></div>
              </div>
              <div class="mt-1 flex gap-2 text-[11px] text-gray-600">
                <span>CRIT: <b x-text="v.CRITICAL||0"></b></span>
                <span>HIGH: <b x-text="v.HIGH||0"></b></span>
                <span>MED: <b x-text="v.MEDIUM||0"></b></span>
                <span>LOW: <b x-text="v.LOW||0"></b></span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <!-- Metrics + Top CVEs -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 md:[grid-auto-rows:1fr] md:items-stretch">
      <!-- Fix availability ring gauge (neutral at 0%) -->
      <div class="card h-full flex items-center gap-3">
        <div class="shrink-0">
          <svg viewBox="0 0 44 44" width="64" height="64" aria-label="Fix availability ring">
            <circle cx="22" cy="22" r="18" fill="none" stroke="#e5e7eb" stroke-width="6"/>
            <circle cx="22" cy="22" r="18" fill="none"
                    :stroke-dasharray="ringCircumference"
                    :stroke-dashoffset="ringOffsetFix"
                    :stroke="fixRateFiltered ? ringColor : '#e5e7eb'"
                    stroke-linecap="round" stroke-width="6"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;"/>
          </svg>
        </div>
        <div>
          <div class="text-xs text-gray-500">Fix availability rate (filtered)</div>
          <div class="text-2xl font-semibold" x-text="fixRateFiltered + '%'"></div>
          <div class="muted mt-1" x-text="fixRateFiltered ? '% of filtered vulns with known fixes' : 'No known fixes in current filter'"></div>
        </div>
      </div>

      <!-- Severity mix donut (colored & aligned) -->
      <div class="card h-full md:col-span-1 flex items-center gap-4">
        <div class="shrink-0">
          <svg viewBox="0 0 44 44" width="88" height="88" aria-label="Severity donut">
            <circle cx="22" cy="22" r="16" fill="none" class="text-gray-200" stroke="currentColor" stroke-width="8"/>
            <!-- fixed per-severity circles to guarantee SVG namespace -->
            <circle cx="22" cy="22" r="16" fill="none"
                    :stroke="donutSegs.CRITICAL.color" :stroke-dasharray="donutSegs.CRITICAL.dash"
                    :stroke-dashoffset="donutSegs.CRITICAL.offset" stroke-width="8"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.CRITICAL.count > 0"/>
            <circle cx="22" cy="22" r="16" fill="none"
                    :stroke="donutSegs.HIGH.color" :stroke-dasharray="donutSegs.HIGH.dash"
                    :stroke-dashoffset="donutSegs.HIGH.offset" stroke-width="8"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.HIGH.count > 0"/>
            <circle cx="22" cy="22" r="16" fill="none"
                    :stroke="donutSegs.MEDIUM.color" :stroke-dasharray="donutSegs.MEDIUM.dash"
                    :stroke-dashoffset="donutSegs.MEDIUM.offset" stroke-width="8"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.MEDIUM.count > 0"/>
            <circle cx="22" cy="22" r="16" fill="none"
                    :stroke="donutSegs.LOW.color" :stroke-dasharray="donutSegs.LOW.dash"
                    :stroke-dashoffset="donutSegs.LOW.offset" stroke-width="8"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.LOW.count > 0"/>
            <circle cx="22" cy="22" r="16" fill="none"
                    :stroke="donutSegs.INFO.color" :stroke-dasharray="donutSegs.INFO.dash"
                    :stroke-dashoffset="donutSegs.INFO.offset" stroke-width="8"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.INFO.count > 0"/>
            <circle cx="22" cy="22" r="16" fill="none"
                    :stroke="donutSegs.UNKNOWN.color" :stroke-dasharray="donutSegs.UNKNOWN.dash"
                    :stroke-dashoffset="donutSegs.UNKNOWN.offset" stroke-width="8"
                    style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.UNKNOWN.count > 0"/>
          </svg>
        </div>
        <div>
          <div class="text-sm font-medium mb-2">Severity mix (filtered)</div>
          <div class="text-xs space-y-1">
            <template x-for="seg in donutLegend" :key="'leg-'+seg.label">
              <div class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded" :style="`background:${seg.color}`"></span>
                <span class="text-gray-600" x-text="`${seg.label}: ${seg.count}`"></span>
              </div>
            </template>
            <div class="muted mt-2" x-text="filterSummary"></div>
          </div>
        </div>
      </div>

      <!-- Top CVEs -->
      <div class="card md:col-span-1">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">Top CVEs</div>
          <button class="text-xs underline" @click="applyTopCVE()">Clear filter</button>
        </div>
        <template x-if="!(metrics.topCVEs||[]).length">
          <div class="muted">No CVE IDs found.</div>
        </template>
        <ul class="text-sm grid grid-cols-1 gap-3 max-h-80 overflow-auto">
          <template x-for="cve in (metrics.topCVEs || [])" :key="'cve-'+cve.id">
            <li class="border rounded-xl p-3">
              <div class="font-medium">
                <button class="text-blue-600 underline" @click="applyTopCVE(cve.id)" x-text="cve.id"></button>
              </div>
              <div class="muted mt-1">
                <span x-text="`Count: ${cve.count}`"></span>
                · <span x-text="`Max CVSS: ${cve.maxCVSS ?? '-'}`"></span>
                <template x-if="(cve.datasets||[]).length">· <span x-text="`Datasets: ${cve.datasets.join(', ')}`"></span></template>
              </div>
            </li>
          </template>
        </ul>
      </div>
    </section>

    <!-- Lightweight analytics row -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- CVSS sparkline (wider & downsampled) -->
      <div class="card">
        <div class="text-sm font-medium mb-2">CVSS distribution (filtered)</div>
        <svg :viewBox="`0 0 ${sparkW} ${sparkH}`" :width="sparkW" :height="sparkH" role="img" aria-label="CVSS sparkline">
          <polyline :points="sparkGrid" fill="none" stroke="#e5e7eb" stroke-width="1"/>
          <polyline :points="cvssPath" fill="none" stroke="#2563eb" stroke-width="2"/>
        </svg>
        <div class="muted mt-2" x-text="cvssStatsText"></div>
      </div>

      <!-- Top components (micro bars) -->
      <div class="card">
        <div class="text-sm font-medium mb-2">Top components (by vulns, filtered)</div>
        <div class="space-y-2">
          <template x-for="row in topComponents" :key="'tc-'+row.name">
            <div class="flex items-center gap-3">
              <div class="w-36 truncate text-xs text-gray-700" :title="row.name" x-text="row.name"></div>
              <div class="flex-1 h-2 bg-gray-200 rounded">
                <div class="h-2 rounded" :style="`width:${row.pct}%; background:#10b981`"></div>
              </div>
              <div class="w-8 text-right text-xs text-gray-500" x-text="row.count"></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Fix rate by dataset (micro bars) -->
      <div class="card">
        <div class="text-sm font-medium mb-2">Fix rate by dataset (filtered)</div>
        <div class="space-y-2">
          <template x-for="row in dsFixRates" :key="'dsfr-'+row.name">
            <div class="flex items-center gap-3">
              <div class="w-32 truncate text-xs text-gray-700" :title="row.name" x-text="row.name"></div>
              <div class="flex-1 h-2 bg-gray-200 rounded">
                <div class="h-2 rounded" :style="`width:${row.rate}%; background:${row.rate>=67?'#10b981':row.rate>=33?'#f59e0b':'#ef4444'}`"></div>
              </div>
              <div class="w-10 text-right text-xs text-gray-500" x-text="row.rate + '%'"></div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <!-- Vulnerabilities table -->
    <section>
      <div class="mb-2 text-sm text-gray-600">
        <span x-text="`Showing ${filtered.length} of ${items.length} vulnerabilities`"></span>
      </div>
      <div class="overflow-x-auto bg-white border rounded-2xl shadow-sm">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr class="text-left">
              <th class="px-4 py-3">Severity</th>
              <th class="px-4 py-3">CVSS</th>
              <th class="px-4 py-3">Component</th>
              <th class="px-4 py-3">Version</th>
              <th class="px-4 py-3">License</th>
              <th class="px-4 py-3">Vuln ID</th>
              <th class="px-4 py-3">Dataset</th>
              <th class="px-4 py-3">Links</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in paged" :key="row._key">
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-2">
                  <span class="px-2 py-0.5 rounded-lg text-xs font-semibold" :class="badge(row.severity)" x-text="row.severity || 'UNKNOWN'"></span>
                </td>
                <td class="px-4 py-2" x-text="row.cvss ?? '-'"></td>
                <td class="px-4 py-2">
                  <div class="font-medium" x-text="row.component || '-'"></div>
                  <div class="text-xs text-gray-500 truncate max-w-[28rem]" x-text="row.purl"></div>
                </td>
                <td class="px-4 py-2" x-text="row.version || '-'"></td>
                <td class="px-4 py-2">
                  <template x-for="(l,i) in (row.licenses || [])" :key="row._key+'-lic-'+i">
                    <span class="mr-1 px-1.5 py-0.5 bg-gray-100 rounded" x-text="l"></span>
                  </template>
                </td>
                <td class="px-4 py-2" x-text="row.id || '-'"></td>
                <td class="px-4 py-2">
                  <span class="text-xs px-2 py-1 bg-gray-100 rounded" x-text="row.dataset"></span>
                  <template x-if="row.direct"><span class="ml-1 text-[10px] px-1 py-0.5 bg-emerald-100 text-emerald-700 rounded">direct</span></template>
                </td>
                <td class="px-4 py-2">
                  <template x-for="(u,i) in (row.urls || [])" :key="row._key+'-url-'+i">
                    <a class="text-blue-600 underline mr-2" :href="u" target="_blank" rel="noopener" x-text="`ref${i+1}`"></a>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">Page <span x-text="page+1"></span> / <span x-text="pages"></span></div>
        <div class="flex gap-2">
          <button class="px-3 py-1 border rounded-lg" :disabled="page===0" @click="prev()">Prev</button>
          <button class="px-3 py-1 border rounded-lg" :disabled="page+1>=pages" @click="next()">Next</button>
        </div>
      </div>
    </section>
  </main>

  <script>
  function app(){
    return {
      // state from parse-sboms.json
      items: [], filtered: [], paged: [], datasets: [],
      overall: { total: 0, severityCounts: {} },
      metrics: { fixAvailabilityRate:0, topCVEs:[] },

      // filters
      dataset: "", q: "", severity: "", fix: "", cvssMin: 0, onlyDirect: false,
      sevOrder: ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN'],

      // derived (filtered)
      sevCountsFiltered: {}, fixRateFiltered: 0, filterSummary: "", perDatasetSev: {},

      // sort/paging
      sortKey: "severityRank", sortDir: "desc", page: 0, perPage: 50, pages: 0,

      metaText: "",

      /* ------- micro-chart helpers ------- */
      // ring gauge
      ringCircumference: 2 * Math.PI * 18, // r=18
      get ringOffsetFix(){
        const pct = Math.max(0, Math.min(100, this.fixRateFiltered)) / 100;
        return this.ringCircumference * (1 - pct);
      },
      get ringColor(){
        const p = this.fixRateFiltered;
        if (p >= 67) return '#10b981'; // green
        if (p >= 33) return '#f59e0b'; // amber
        return '#ef4444';              // red
      },

      // severity donut (fixed circles so colors always render)
      donutSegs: {
        CRITICAL:{dash:'0 1000', offset:0, color:'#dc2626', count:0},
        HIGH:{dash:'0 1000', offset:0, color:'#f87171', count:0},
        MEDIUM:{dash:'0 1000', offset:0, color:'#f59e0b', count:0},
        LOW:{dash:'0 1000', offset:0, color:'#10b981', count:0},
        INFO:{dash:'0 1000', offset:0, color:'#9ca3af', count:0},
        UNKNOWN:{dash:'0 1000', offset:0, color:'#d1d5db', count:0},
      },
      donutLegend: [],
      buildSeverityDonut(){
        const order = ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN'];
        const counts = this.sevCountsFiltered || {};
        const total = Object.values(counts).reduce((a,b)=>a+(b||0),0) || 0;
        const r = 16, C = 2 * Math.PI * r;
        let acc = 0;
        this.donutLegend = [];
        // reset all
        for (const k of order){
          this.donutSegs[k].dash = `0 ${C.toFixed(2)}`;
          this.donutSegs[k].offset = 0;
          this.donutSegs[k].count = 0;
        }
        for (const label of order){
          const count = counts[label] || 0;
          if (!count) continue;
          const pct = count / Math.max(1, total);
          const segLen = pct * C;
          this.donutSegs[label].dash = `${segLen.toFixed(2)} ${(C - segLen).toFixed(2)}`;
          this.donutSegs[label].offset = (C * (1 - acc)).toFixed(2);
          this.donutSegs[label].count = count;
          acc += pct;
          this.donutLegend.push({ label, color: this.donutSegs[label].color, count });
        }
      },

      // sparkline (wider & downsampled)
      sparkW: 360, sparkH: 64,
      cvssPath: "", sparkGrid: "", cvssStatsText: "",
      buildCvssSpark(){
        const w=this.sparkW, h=this.sparkH, pad=6;
        const xs = this.filtered.map(r=>typeof r.cvss==='number'?r.cvss:null).filter(v=>v!=null);
        const n=xs.length;
        this.sparkGrid = `0,${h-1} ${w},${h-1} 0,${Math.round(h/2)} ${w},${Math.round(h/2)} 0,1 ${w},1`;
        if (!n){ this.cvssPath=""; this.cvssStatsText="no scores"; return; }
        const sorted=[...xs].sort((a,b)=>a-b);
        const min=sorted[0], max=sorted[sorted.length-1];
        const q = (p)=>sorted[Math.floor((sorted.length-1)*p)];
        const med=q(0.5).toFixed(1), p90=q(0.9).toFixed(1);
        // downsample to ~80 points for readability
        const step = Math.max(1, Math.floor(n/80));
        const vals = xs.filter((_,i)=>i%step===0);
        const m = vals.length;
        const scaleX=(i)=> pad + (i/(m-1))*(w-2*pad);
        const scaleY=(v)=> pad + (1-((v-0)/10))*(h-2*pad);
        this.cvssPath = vals.map((v,i)=>`${scaleX(i)},${scaleY(v)}`).join(' ');
        this.cvssStatsText = `n=${n} · min=${min?.toFixed(1)} · med=${med} · p90=${p90}`;
      },

      // top components micro bars
      topComponents: [],
      buildTopComponents(){
        const counts = {};
        for (const r of this.filtered){
          const name = r.component || 'unknown';
          counts[name] = (counts[name]||0)+1;
        }
        const arr = Object.entries(counts).map(([name,count])=>({name,count}));
        arr.sort((a,b)=>b.count-a.count);
        const top = arr.slice(0,6);
        const max = top[0]?.count || 1;
        this.topComponents = top.map(x=>({ ...x, pct: Math.round(100*x.count/max) }));
      },

      // fix rate by dataset micro bars
      dsFixRates: [],
      buildDsFixRates(){
        const map = {};
        for (const r of this.filtered){
          const d = r.dataset || 'unknown';
          if (!map[d]) map[d] = {name:d, total:0, fix:0};
          map[d].total++; if ((r.fixedVersions||[]).length) map[d].fix++;
        }
        const rows = Object.values(map).map(x=>({
          name: x.name,
          rate: x.total ? Math.round(100*x.fix/x.total) : 0
        }));
        rows.sort((a,b)=>b.rate-a.rate);
        this.dsFixRates = rows.slice(0,6);
      },

      async init(){
        const snap = await fetch("./parse-sboms.json?_=" + Date.now()).then(r => r.json());
        this.items = (snap.items || []).map((r, idx) => ({
          ...r,
          _key: (r.dataset || 'ds') + '::' + (r.id || (r.component || 'comp') + '@' + (r.version || '')) + '::' + idx
        }));
        this.datasets = (snap.datasets || [])
          .map((d, i) => ({ ...d, _key: 'ds-' + (d.id || i) }))
          .sort((a,b)=>String(a.id).localeCompare(String(b.id)));

        this.overall = snap.overall || this.overall;
        this.metrics = snap.metrics || this.metrics;
        this.metaText = snap.generatedAt ? `updated ${new Date(snap.generatedAt).toLocaleString()}` : '';

        this.restoreFromHash();
        this.applyFilters(true);
      },

      // utils
      badge(sev){
        const s = (sev||"").toUpperCase();
        const base = "px-2 py-0.5 rounded-lg text-xs font-semibold";
        if (s==="CRITICAL") return base+" bg-red-600 text-white";
        if (s==="HIGH") return base+" bg-red-200 text-red-800";
        if (s==="MEDIUM") return base+" bg-amber-100 text-amber-800";
        if (s==="LOW") return base+" bg-green-100 text-green-800";
        return base+" bg-gray-100 text-gray-800";
      },

      applyFilters(buildGroup=false){
        const q = this.q.trim().toLowerCase();
        const sev = this.severity, fix = this.fix, cv = Number(this.cvssMin) || 0, ds = this.dataset;

        this.filtered = this.items.filter(r => {
          if (ds && r.dataset !== ds) return false;
          if (sev && (r.severity||"").toUpperCase() !== sev) return false;
          if (this.onlyDirect && !r.direct) return false;
          if (cv && (r.cvss ?? -1) < cv) return false;
          if (fix === "has" && !(r.fixedVersions || []).length) return false;
          if (fix === "none" && (r.fixedVersions || []).length) return false;
          if (q) {
            const t = [r.component, r.purl, r.id, (r.licenses||[]).join(" "), (r.dataset||"")].join(" ").toLowerCase();
            if (!t.includes(q)) return false;
          }
          return true;
        });

        // sorting
        const key = this.sortKey;
        const dir = this.sortDir === "desc" ? -1 : 1;
        this.filtered.sort((a,b)=>{
          const A = (a[key] ?? ""), B = (b[key] ?? "");
          if (typeof A === "number" && typeof B === "number") return (A-B)*dir;
          return String(A).localeCompare(String(B)) * dir;
        });

        // paginate
        this.page = 0; this.paginate();

        // derive filtered metrics
        this.sevCountsFiltered = this.countSev(this.filtered);
        const hasFix = this.filtered.filter(r => (r.fixedVersions||[]).length).length;
        this.fixRateFiltered = this.filtered.length ? Math.round(100 * (hasFix/this.filtered.length)) : 0;
        this.perDatasetSev = this.groupByDatasetSev(this.filtered);
        this.filterSummary = this.buildFilterSummary();

        // build charts/analytics
        this.buildSeverityDonut();
        this.buildCvssSpark();
        this.buildTopComponents();
        this.buildDsFixRates();

        this.persistToHash();
      },
      paginate(){
        this.pages = Math.max(1, Math.ceil(this.filtered.length / this.perPage));
        const start = this.page * this.perPage;
        this.paged = this.filtered.slice(start, start + this.perPage);
      },
      next(){ if (this.page+1 < this.pages){ this.page++; this.paginate(); this.persistToHash(); } },
      prev(){ if (this.page>0){ this.page--; this.paginate(); this.persistToHash(); } },

      // helpers for filtered stats
      countSev(list){
        const out = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,UNKNOWN:0};
        for (const r of list){ const s=(r.severity||'UNKNOWN').toUpperCase(); out[s]=(out[s]||0)+1; }
        return out;
      },
      groupByDatasetSev(list){
        const map = {};
        for (const r of list){
          const ds = r.dataset || 'unknown';
          if (!map[ds]) map[ds] = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,UNKNOWN:0,total:0};
          const s=(r.severity||'UNKNOWN').toUpperCase();
          map[ds][s] = (map[ds][s]||0)+1;
          map[ds].total++;
        }
        return map;
      },
      buildFilterSummary(){
        const bits = [];
        if (this.dataset) bits.push(`dataset=${this.dataset}`);
        if (this.severity) bits.push(`severity=${this.severity}`);
        if (this.fix) bits.push(`fix=${this.fix}`);
        if (this.cvssMin) bits.push(`cvss≥${this.cvssMin}`);
        if (this.onlyDirect) bits.push(`onlyDirect`);
        if (this.q) bits.push(`q="${this.q}"`);
        return bits.length ? bits.join(' · ') : 'no filters';
      },

      // CSV
      exportCSV(){
        const rows = this.filtered;
        if (!rows.length) { alert("No rows to export."); return; }
        const header = ["severity","cvss","component","version","purl","licenses","id","dataset","links","direct"];
        const lines = [header.join(",")];
        for (const r of rows) {
          const csv = [
            r.severity ?? "", r.cvss ?? "", r.component ?? "", r.version ?? "", r.purl ?? "",
            (r.licenses||[]).join("|"), r.id ?? "", r.dataset ?? "", (r.urls||[]).join("|"),
            r.direct ? "yes" : "no"
          ].map(x => `"${String(x).replace(/"/g,'""')}"`).join(",");
          lines.push(csv);
        }
        const blob = new Blob([lines.join("\n")], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "sbom-filtered.csv"; a.click();
        URL.revokeObjectURL(url);
      },

      // URL state
      persistToHash(){
        const h = new URLSearchParams({
          q: this.q || "", ds: this.dataset || "", sev: this.severity || "",
          fix: this.fix || "", cvss: String(this.cvssMin || 0),
          dir: this.sortDir, key: this.sortKey, dirc: this.onlyDirect ? "1" : "0",
          p: String(this.page)
        }).toString();
        location.hash = h;
      },
      restoreFromHash(){
        const s = new URLSearchParams(location.hash.replace(/^#/, ""));
        this.q = s.get("q") || this.q;
        this.dataset = s.get("ds") || this.dataset;
        this.severity = s.get("sev") || this.severity;
        this.fix = s.get("fix") || this.fix;
        this.cvssMin = Number(s.get("cvss") || this.cvssMin || 0);
        this.sortDir = s.get("dir") || this.sortDir;
        this.sortKey = s.get("key") || this.sortKey;
        this.onlyDirect = s.get("dirc")==="1" ? true : this.onlyDirect;
        this.page = Number(s.get("p") || this.page || 0);
      },

      // Top CVE helper
      applyTopCVE(id){
        if (!id) { this.q=""; this.applyFilters(true); return; }
        this.q = id;
        this.applyFilters(true);
      },

      // tiny helpers for view save/load
      saveView(){ try{ localStorage.setItem('sbom_view', location.hash); alert('View saved.'); }catch{} },
      loadView(){ try{ const h = localStorage.getItem('sbom_view'); if(h){ location.hash=h; this.restoreFromHash(); this.applyFilters(true);} }catch{} }
    }
  }
  </script>
</body>
</html>
