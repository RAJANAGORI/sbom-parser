<!doctype html>
<html lang="en" x-data="app()" x-init="init()" class="h-full bg-[#0a0e14] antialiased">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SBOM Explorer</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Content Security Policy: Allow CDN scripts and inline styles (required for Tailwind/Alpine) -->
  <!-- Note: 'unsafe-eval' is required for Alpine.js, 'unsafe-inline' for Tailwind CDN -->
  <!-- Content Security Policy: Allow CDN scripts, blob URLs for downloads, and required inline execution -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net 'unsafe-eval' blob:; script-src-elem 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net blob:; style-src 'self' https://cdn.tailwindcss.com https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; img-src 'self' data: https:; frame-src 'none'; base-uri 'self'; form-action 'self'; object-src 'none';" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./scripts/security.js"></script>
  <link rel="stylesheet" href="./styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <script src="./app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Source+Code+Pro:wght@400;600&display=swap"
    rel="stylesheet">
</head>

<body class="h-full text-gray-100 bg-[#0a0e14]">
  <header
    class="sticky top-0 z-40 bg-[#1a1f2e]/90 backdrop-blur border-b border-[#2d3748] transition-all duration-300 ease-in-out"
    :class="mobileFilters ? 'sm:ml-[28rem] xl:ml-[32rem]' : ''">
    <div class="px-3 sm:px-4 py-2 sm:py-3 flex items-center gap-2 sm:gap-3">
      <button class="sm:hidden p-2 rounded-xl border border-[#2d3748]" @click="toggleSidebar()"
        aria-label="Toggle filters">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M3 5h18M6 12h12M10 19h4" />
        </svg>
      </button>
      <button
        class="hidden sm:inline-flex items-center gap-2 px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] hover:bg-[#A1D6E2] hover:text-[#0a0e14] hover:border-[#A1D6E2]"
        @click="toggleSidebar()" aria-label="Toggle filters">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8">
          <path d="M3 5h18M6 12h12M10 19h4" />
        </svg>
        Filters
      </button>
      <h1 class="text-base sm:text-xl font-semibold">SBOM Explorer</h1>
      <span class="text-xs text-[#94a3b8] ml-2" x-text="metaText" aria-live="polite"></span>

      <div class="ml-auto flex items-center gap-1 sm:gap-2">
        <button
          class="hidden sm:inline px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] hover:bg-[#A1D6E2] hover:text-[#0a0e14] hover:border-[#A1D6E2]"
          @click="exportCSV()">Export CSV</button>
        <button
          class="hidden sm:inline px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] hover:bg-[#A1D6E2] hover:text-[#0a0e14] hover:border-[#A1D6E2]"
          @click="saveView()">Save View</button>
        <button
          class="hidden sm:inline px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] hover:bg-[#A1D6E2] hover:text-[#0a0e14] hover:border-[#A1D6E2]"
          @click="loadView()">Load View</button>

        <div class="sm:hidden relative" x-data="{open:false}" @keydown.escape.window="open=false">
          <button class="p-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e]" @click="open=!open"
            :aria-expanded="open.toString()" aria-haspopup="menu" aria-label="Actions">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8">
              <circle cx="12" cy="12" r="1.5" />
              <circle cx="5" cy="12" r="1.5" />
              <circle cx="19" cy="12" r="1.5" />
            </svg>
          </button>
          <div x-cloak x-show="open" @click.outside="open=false"
            class="absolute right-0 mt-2 w-44 bg-[#1a1f2e] border border-[#2d3748] rounded-xl shadow-lg overflow-hidden">
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-[#2d3748]"
              @click="exportCSV(); open=false">Export CSV</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-[#2d3748]" @click="saveView(); open=false">Save
              View</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-[#2d3748]" @click="loadView(); open=false">Load
              View</button>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-3 sm:px-4 pb-2 sm:pb-3 hidden">
      <label class="text-sm">Search
        <div class="relative mt-1" x-ref="searchWrap">
          <input id="q" x-ref="search" x-model="q" @input="onInput" @keydown.down.prevent="moveSel(1)"
            @keydown.up.prevent="moveSel(-1)" @keydown.enter.prevent="applySel()"
            @keydown.escape.prevent="hideSuggest()" placeholder="Search (component, purl, vuln id, license)"
            class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring" aria-autocomplete="list"
            :aria-expanded="(showSuggest && suggestions.length) ? 'true' : 'false'" aria-haspopup="listbox"
            inputmode="search" autocomplete="off" />

          <div x-ref="suggest" x-show="showSuggest && suggestions.length" @pointerdown.prevent
            class="absolute z-50 mt-1 w-full bg-[#1a1f2e] border border-[#2d3748] rounded-xl shadow-lg max-h-72 overflow-auto"
            role="listbox">
            <template x-for="(s, i) in suggestions" :key="s.key">
              <button type="button" @pointerdown.prevent @click="pick(s)"
                :class="['w-full text-left px-3 py-2 flex items-center gap-2', i===selIdx ? 'bg-[#2d3748]' : 'hover:bg-[#2d3748]']"
                :aria-selected="i===selIdx" role="option" style="min-height:44px">
                <span class="text-[11px] px-1.5 py-0.5 rounded bg-[#2d3748]" x-text="s.group"></span>
                <span class="truncate flex-1" x-text="s.label"></span>
                <span class="text-xs text-[#94a3b8]" x-text="s.meta"></span>
              </button>
            </template>
          </div>
        </div>
      </label>

      <select x-model="dataset" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl min-w-[10rem]"
        aria-label="Filter by dataset">
        <option value="">All datasets</option>
        <template x-for="d in datasets" :key="d._key">
          <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
        </template>
      </select>

      <select x-model="severity" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl"
        aria-label="Filter by severity">
        <option value="">All severities</option>
        <template x-for="s in sevOpts" :key="s">
          <option :value="s" x-text="s"></option>
        </template>
      </select>

      <select x-model="fix" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl"
        aria-label="Filter by fix availability">
        <option value="">Has fix?</option>
        <option value="has">Has fix</option>
        <option value="none">No fix</option>
      </select>

      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <span class="text-sm">CVSS ≥</span>
        <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin" @input="applyFilters(true)"
          class="min-w-[10rem] outline-none" aria-label="Minimum CVSS" />
      </label>



      <div class="ml-auto flex items-center gap-2 text-sm">
        <label class="whitespace-nowrap">Sort:</label>
        <select x-model="sortKey" @change="applyFilters()" class="px-2 py-1 border rounded-lg" aria-label="Sort key">
          <option value="severityRank">Severity</option>
          <option value="cvss">CVSS</option>
          <option value="component">Component</option>
          <option value="dataset">Dataset</option>
        </select>
        <button class="px-2 py-1 border rounded-lg" @click="sortDir = sortDir==='desc'?'asc':'desc'; applyFilters()"
          :aria-label="'Sort ' + (sortDir==='desc'?'descending':'ascending')"
          x-text="sortDir==='desc' ? '↓' : '↑'"></button>


        <button class="px-3 py-2 border rounded-xl hidden sm:inline-flex" @click="resetFilters()"
          aria-label="Reset all filters" title="Reset all filters">Reset</button>
      </div>
    </div>
  </header>

  <div x-cloak x-show="mobileFilters" class="fixed inset-0 z-50" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/30" @click="mobileFilters=false"></div>
    <section
      class="hidden sm:flex absolute left-0 top-0 bottom-0 w-full sm:w-[28rem] xl:w-[32rem] max-w-full sm:max-w-[28rem] xl:max-w-[32rem] bg-[#1a1f2e] border-r border-[#2d3748] shadow-lg flex-col">
      <header class="p-3 flex items-center gap-2 border-b border-[#2d3748]">
        <div class="font-medium">Filters</div>
        <button class="ml-auto p-2 rounded-xl border border-[#2d3748] bg-[#1a1f2e]" @click="toggleSidebar()"
          aria-label="Close filters">✕</button>
      </header>
      <div class="p-3 space-y-3 overflow-auto">
        <label class="text-xs text-[#94a3b8]">Search
          <div class="relative mt-1" x-ref="searchWrap">
            <input id="q-d" x-ref="search" x-model="q" @input="onInput" @keydown.down.prevent="moveSel(1)"
              @keydown.up.prevent="moveSel(-1)" @keydown.enter.prevent="applySel()"
              @keydown.escape.prevent="hideSuggest()" placeholder="Search (component, purl, vuln id, license)"
              class="w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0] placeholder-[#94a3b8]"
              inputmode="search" autocomplete="off" />
            <div x-ref="suggest" x-show="showSuggest && suggestions.length" @pointerdown.prevent
              class="absolute z-50 mt-1 w-full bg-[#1a1f2e] border border-[#2d3748] rounded-xl shadow-lg max-h-72 overflow-auto"
              role="listbox">
              <template x-for="(s, i) in suggestions" :key="s.key">
                <button type="button" @pointerdown.prevent @click="pick(s)"
                  :class="['w-full text-left px-3 py-2 flex items-center gap-2', i===selIdx ? 'bg-[#2d3748]' : 'hover:bg-[#2d3748]']"
                  :aria-selected="i===selIdx" role="option" style="min-height:44px">
                  <span class="text-[11px] px-1.5 py-0.5 rounded bg-[#2d3748]" x-text="s.group"></span>
                  <span class="truncate flex-1" x-text="s.label"></span>
                  <span class="text-xs text-[#94a3b8]" x-text="s.meta"></span>
                </button>
              </template>
            </div>
          </div>
        </label>
        <div class="grid grid-cols-1 gap-3">
          <label class="text-xs text-[#94a3b8]">Dataset
            <select x-model="dataset"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0]">
              <option value="">All datasets</option>
              <template x-for="d in datasets" :key="d._key">
                <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
              </template>
            </select>
          </label>
          <label class="text-xs text-[#94a3b8]">Severity
            <select x-model="severity"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0]">
              <option value="">All severities</option>
              <template x-for="s in sevOpts" :key="s">
                <option :value="s" x-text="s"></option>
              </template>
            </select>
          </label>
          <label class="text-xs text-[#94a3b8]">Fix status
            <select x-model="fix"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0]">
              <option value="">Has fix?</option>
              <option value="has">Has fix</option>
              <option value="none">No fix</option>
            </select>
          </label>
          <label class="text-xs text-[#94a3b8]">CVSS minimum
            <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0] placeholder-[#94a3b8]" />
          </label>

        </div>
      </div>
      <div class="p-3 grid grid-cols-2 gap-2 border-t border-[#2d3748]">
        <button class="btn"
          :class="lastAction === 'apply' ? 'bg-[#A1D6E2] text-[#0a0e14] border-[#A1D6E2]' : 'bg-[#1a1f2e] border-[#2d3748] text-[#e2e8f0]'"
          @click="applyFilters(true); toggleSidebar(); lastAction='apply'">Apply</button>
        <button class="btn"
          :class="lastAction === 'reset' ? 'bg-[#A1D6E2] text-[#0a0e14] border-[#A1D6E2]' : 'bg-[#1a1f2e] border-[#2d3748] text-[#e2e8f0]'"
          @click="resetFilters(); toggleSidebar(); lastAction='reset'">Reset</button>
      </div>
    </section>
    <section
      class="absolute inset-x-0 bottom-0 max-h-[85vh] bg-[#1a1f2e] border-t border-[#2d3748] rounded-t-2xl shadow-lg flex sm:hidden flex-col mobile-sidebar">
      <header class="p-3 flex items-center gap-2">
        <div class="mobile-sidebar-handle"></div>
        <button class="ml-auto p-2 rounded-xl border border-[#2d3748] bg-[#1a1f2e]" @click="toggleSidebar()"
          aria-label="Close filters">✕</button>
      </header>
      <div class="p-3 space-y-3 overflow-auto">
        <label class="text-xs text-[#94a3b8]">Search
          <div class="relative mt-1" x-ref="searchWrap">
            <input id="q-m" x-ref="search" x-model="q" @input="onInput" @keydown.down.prevent="moveSel(1)"
              @keydown.up.prevent="moveSel(-1)" @keydown.enter.prevent="applySel()"
              @keydown.escape.prevent="hideSuggest()" placeholder="Search (component, purl, vull id, license)"
              class="w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0] placeholder-[#94a3b8]"
              inputmode="search" autocomplete="off" />
            <div x-ref="suggest" x-show="showSuggest && suggestions.length" @pointerdown.prevent
              class="absolute z-50 mt-1 w-full bg-[#1a1f2e] border border-[#2d3748] rounded-xl shadow-lg max-h-72 overflow-auto"
              role="listbox">
              <template x-for="(s, i) in suggestions" :key="s.key">
                <button type="button" @pointerdown.prevent @click="pick(s)"
                  :class="['w-full text-left px-3 py-2 flex items-center gap-2', i===selIdx ? 'bg-[#2d3748]' : 'hover:bg-[#2d3748]']"
                  :aria-selected="i===selIdx" role="option" style="min-height:44px">
                  <span class="text-[11px] px-1.5 py-0.5 rounded bg-[#2d3748]" x-text="s.group"></span>
                  <span class="truncate flex-1" x-text="s.label"></span>
                  <span class="text-xs text-[#94a3b8]" x-text="s.meta"></span>
                </button>
              </template>
            </div>
          </div>
        </label>
        <div class="grid grid-cols-1 gap-3">
          <label class="text-xs text-[#94a3b8]">Dataset
            <select x-model="dataset"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0]">
              <option value="">All datasets</option>
              <template x-for="d in datasets" :key="d._key">
                <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
              </template>
            </select>
          </label>
          <label class="text-xs text-[#94a3b8]">Severity
            <select x-model="severity"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0]">
              <option value="">All severities</option>
              <template x-for="s in sevOpts" :key="s">
                <option :value="s" x-text="s"></option>
              </template>
            </select>
          </label>
          <label class="text-xs text-[#94a3b8]">Fix status
            <select x-model="fix"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0]">
              <option value="">Has fix?</option>
              <option value="has">Has fix</option>
              <option value="none">No fix</option>
            </select>
          </label>
          <label class="text-xs text-[#94a3b8]">CVSS minimum
            <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin"
              class="mt-1 w-full px-3 py-2 border border-[#2d3748] rounded-xl bg-[#1a1f2e] text-[#e2e8f0] placeholder-[#94a3b8]" />
          </label>

        </div>
      </div>
      <div class="sticky-actions p-3 grid grid-cols-2 gap-2">
        <button class="btn"
          :class="lastAction === 'apply' ? 'bg-[#A1D6E2] text-[#0a0e14] border-[#A1D6E2]' : 'bg-[#1a1f2e] border-[#2d3748] text-[#e2e8f0]'"
          @click="applyFilters(true); toggleSidebar(); lastAction='apply'">Apply</button>
        <button class="btn"
          :class="lastAction === 'reset' ? 'bg-[#A1D6E2] text-[#0a0e14] border-[#A1D6E2]' : 'bg-[#1a1f2e] border-[#2d3748] text-[#e2e8f0]'"
          @click="resetFilters(); toggleSidebar(); lastAction='reset'">Reset</button>
      </div>
    </section>
  </div>

  <main class="px-3 sm:px-4 py-4 sm:py-6 transition-all duration-300 ease-in-out" x-cloak
    :class="mobileFilters ? 'sm:ml-[28rem] xl:ml-[32rem] sidebar-open' : ''">
    <div class="space-y-6 w-full"
      :class="mobileFilters ? 'sm:ml-0 xl:ml-0' : ''">
    <section class="grid grid-cols-1 xl:grid-cols-12 gap-3 sm:gap-4 mb-4 sm:mb-6" aria-live="polite">
      <div class="xl:col-span-8 grid grid-cols-2 md:grid-cols-6 gap-3">
        <div class="card col-span-2">
          <div class="text-xs text-[#94a3b8]">Total vulnerabilities</div>
          <div class="text-2xl font-semibold" x-text="filtered.length"></div>
          <div class="muted mt-1" x-text="filterSummary"></div>
        </div>
        <template x-for="sev in ['CRITICAL','HIGH','MEDIUM','LOW']" :key="'sev-'+sev">
          <div class="card">
            <div class="text-xs text-[#94a3b8]" x-text="sev"></div>
            <div class="text-xl font-semibold" x-text="sevCountsFiltered[sev] || 0"></div>
          </div>
        </template>
      </div>

      <div class="card xl:col-span-4">
        <div class="text-sm font-medium mb-3">Datasets in view</div>
        <template x-if="Object.keys(perDatasetSev).length === 0">
          <div class="muted">No datasets in the current view.</div>
        </template>
        <div class="space-y-3 max-h-60 overflow-auto">
          <template x-for="(v, name) in perDatasetSev" :key="'ds-'+name">
            <div>
              <div class="flex items-center justify-between text-sm">
                <div class="font-medium truncate" x-text="name"></div>
                <div class="text-xs text-[#94a3b8]" x-text="`${v.total} vulns`"></div>
              </div>
              <div class="bar">
                <div class="bar-fill" :style="`width:${Math.min(100, (v.total/Math.max(1, filtered.length))*100)}%`">
                </div>
              </div>
              <div class="mt-1 flex flex-wrap gap-2 text-[11px] text-[#94a3b8]">
                <span>CRIT: <b x-text="v.CRITICAL||0"></b></span>
                <span>HIGH: <b x-text="v.HIGH||0"></b></span>
                <span>MED: <b x-text="v.MEDIUM||0"></b></span>
                <span>LOW: <b x-text="v.LOW||0"></b></span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <section class="grid grid-cols-1 xl:grid-cols-12 gap-3 sm:gap-4 mb-4 sm:mb-6">

      <div class="xl:col-span-8 grid gap-4 items-stretch [grid-template-columns:repeat(auto-fit,minmax(140px,1fr))]">

        <div class="card h-full flex items-start gap-3" x-show="fixRateFiltered > 0">
          <div class="shrink-0">
            <svg viewBox="0 0 44 44" width="64" height="64" aria-label="Fix availability">
              <circle cx="22" cy="22" r="18" fill="none" stroke="#e5e7eb" stroke-width="6" />
              <circle cx="22" cy="22" r="18" fill="none" :stroke-dasharray="ringCircumference"
                :stroke-dashoffset="ringOffsetFix" :stroke="fixRateFiltered ? ringColor : '#e5e7eb'"
                stroke-linecap="round" stroke-width="6" style="transform: rotate(-90deg); transform-origin: 50% 50%;" />
            </svg>
          </div>
          <div>
            <div class="text-xs text-[#94a3b8]">Fix availability</div>
            <div class="text-2xl font-semibold" x-text="fixRateFiltered + '%' "></div>
            <div class="muted mt-1"
              x-text="fixRateFiltered ? '% of vulnerabilities with known fixes' : 'No known fixes in this view'">
            </div>
          </div>
        </div>

        <div class="card h-full md:col-span-1 flex items-start gap-4">
          <div class="shrink-0">
            <svg viewBox="0 0 44 44" width="88" height="88" aria-label="Severity mix">
              <circle cx="22" cy="22" r="16" fill="none" class="text-[#2d3748]" stroke="currentColor"
                stroke-width="8" />
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.CRITICAL.color"
                :stroke-dasharray="donutSegs.CRITICAL.dash" :stroke-dashoffset="donutSegs.CRITICAL.offset"
                stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;"
                x-show="donutSegs.CRITICAL.count > 0" />
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.HIGH.color"
                :stroke-dasharray="donutSegs.HIGH.dash" :stroke-dashoffset="donutSegs.HIGH.offset" stroke-width="8"
                style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.HIGH.count > 0" />
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.MEDIUM.color"
                :stroke-dasharray="donutSegs.MEDIUM.dash" :stroke-dashoffset="donutSegs.MEDIUM.offset" stroke-width="8"
                style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.MEDIUM.count > 0" />
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.LOW.color"
                :stroke-dasharray="donutSegs.LOW.dash" :stroke-dashoffset="donutSegs.LOW.offset" stroke-width="8"
                style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.LOW.count > 0" />
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.INFO.color"
                :stroke-dasharray="donutSegs.INFO.dash" :stroke-dashoffset="donutSegs.INFO.offset" stroke-width="8"
                style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.INFO.count > 0" />
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.UNKNOWN.color"
                :stroke-dasharray="donutSegs.UNKNOWN.dash" :stroke-dashoffset="donutSegs.UNKNOWN.offset"
                stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;"
                x-show="donutSegs.UNKNOWN.count > 0" />
            </svg>
          </div>
          <div>
            <div class="text-sm font-medium mb-2">Severity mix</div>
            <div class="text-xs space-y-1">
              <template x-for="seg in donutLegend" :key="'leg-'+seg.label">
                <div class="flex items-center gap-2">
                  <span class="inline-block w-3 h-3 rounded" :style="`background:${seg.color}`"></span>
                  <span class="text-[#94a3b8]" x-text="`${seg.label}: ${seg.count}`"></span>
                </div>
              </template>
              <div class="muted mt-2" x-text="filterSummary"></div>
            </div>
          </div>
        </div>

        <div class="card h-full">
          <div class="text-sm font-medium mb-2">Top components by vulnerabilities</div>
          <div class="space-y-2">
            <template x-for="row in topComponents" :key="'tc-'+row.name">
              <div class="flex items-center gap-3">
                <div class="w-36 truncate text-xs text-[#e2e8f0]" :title="row.name" x-text="row.name"></div>
                <div class="flex-1 h-2 bg-[#2d3748] rounded">
                  <div class="h-2 rounded" :style="`width:${row.pct}%; background:#10b981`"></div>
                </div>
                <div class="w-8 text-right text-xs text-[#94a3b8]" x-text="row.count"></div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div class="card xl:col-span-4 h-full">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">Top CVEs</div>
          <button class="text-xs underline" @click="applyTopCVE()">Clear filter</button>
        </div>
        <template x-if="!(metrics.topCVEs||[]).length">
          <div class="muted">No CVE IDs found.</div>
        </template>
        <ul class="text-sm grid grid-cols-1 gap-3 max-h-80 overflow-auto">
          <template x-for="cve in (metrics.topCVEs || [])" :key="'cve-'+cve.id">
            <li class="border rounded-xl p-3">
              <div class="font-medium">
                <button class="text-blue-600 underline" @click="applyTopCVE(cve.id)" x-text="cve.id"></button>
              </div>
              <div class="muted mt-1">
                <span x-text="`Count: ${cve.count}`"></span>
                · <span x-text="`Max CVSS: ${cve.maxCVSS ?? '-'}`"></span>
                <template x-if="(cve.datasets||[]).length">· <span
                    x-text="`Datasets: ${cve.datasets.join(', ')}`"></span></template>
              </div>
            </li>
          </template>
        </ul>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
      <div class="card h-full">
        <div class="text-sm font-medium mb-2">CVSS distribution</div>
        <svg :viewBox="`0 0 ${sparkW} ${sparkH}`" :width="sparkW" :height="sparkH" role="img"
          aria-label="CVSS sparkline">
          <polyline :points="sparkGrid" fill="none" stroke="#e5e7eb" stroke-width="1" />
          <polyline :points="cvssPath" fill="none" stroke="#2563eb" stroke-width="2" />
        </svg>
        <div class="muted mt-2" x-text="cvssStatsText"></div>
      </div>

      <div class="card">
        <div class="text-sm font-medium mb-2">Top licenses by vulnerabilities</div>
        <div class="space-y-2">
          <template x-for="row in topLicenses" :key="'tl-'+row.name">
            <div class="flex items-center gap-3">
              <div class="w-36 truncate text-xs text-[#e2e8f0]" :title="row.name" x-text="row.name"></div>
              <div class="flex-1 h-2 bg-[#2d3748] rounded">
                <div class="h-2 rounded" :style="`width:${row.pct}%; background:#6366f1`"></div>
              </div>
              <div class="w-8 text-right text-xs text-[#94a3b8]" x-text="row.count"></div>
            </div>
          </template>
          <template x-if="!topLicenses.length">
            <div class="muted">No license data</div>
          </template>
        </div>
      </div>

      <div class="card">
        <div class="text-sm font-medium mb-2">Fix availability by dataset</div>
        <div class="space-y-2">
          <template x-for="row in dsFixRates" :key="'dsfr-'+row.name">
            <div class="flex items-center gap-3">
              <div class="w-32 truncate text-xs text-[#e2e8f0]" :title="row.name" x-text="row.name"></div>
              <div class="flex-1 h-2 bg-[#2d3748] rounded">
                <div class="h-2 rounded"
                  :style="`width:${row.rate}%; background:${row.rate>=67?'#10b981':row.rate>=33?'#f59e0b':'#ef4444'}`">
                </div>
              </div>
              <div class="w-10 text-right text-xs text-[#94a3b8]" x-text="row.rate + '%' "></div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <section class="w-full">
      <div class="mb-2 text-sm text-[#94a3b8]">
        <span x-text="`Showing ${filtered.length} of ${items.length} vulnerabilities`"></span>
      </div>
      <div class="overflow-x-auto bg-[#1a1f2e] border border-[#2d3748] rounded-2xl shadow-sm w-full"
        :class="mobileFilters ? 'sm:max-w-none' : ''">
        <table class="min-w-full text-sm responsive">
          <thead class="bg-[#2d3748]/60">
            <tr class="text-left">
              <th class="px-4 py-3">Severity</th>
              <th class="px-4 py-3">CVSS</th>
              <th class="px-4 py-3">Component</th>
              <th class="px-4 py-3">Version</th>
              <th class="px-4 py-3">License</th>
              <th class="px-4 py-3">Vuln ID</th>
              <th class="px-4 py-3 w-40">Dataset</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in paged" :key="row._key">
              <tr class="border-t border-[#2d3748] hover:bg-[#2d3748]/60">
                <td class="px-4 py-2" :data-label="'Severity'">
                  <span class="px-2 py-0.5 rounded-lg text-xs font-semibold" :class="badge(row.severity)"
                    x-text="row.severity || 'UNKNOWN'"></span>
                </td>
                <td class="px-4 py-2" :data-label="'CVSS'" x-text="row.cvss ?? '-' "></td>
                <td class="px-4 py-2" :data-label="'Component'">
                  <div class="font-medium flex items-center gap-1">
                    <svg aria-hidden="true" viewBox="0 0 24 24" width="14" height="14" class="text-[#94a3b8]">
                      <path fill="currentColor" d="M4 4h6l2 2h8v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" />
                    </svg>
                    <span x-text="row.component || '-' "></span>
                  </div>
                  <div class="text-xs text-[#94a3b8] truncate max-w-[28rem]" x-text="row.purl"></div>
                </td>
                <td class="px-4 py-2" :data-label="'Version'" x-text="row.version || '-' "></td>
                <td class="px-4 py-2" :data-label="'License'">
                  <template x-for="(l,i) in (row.licenses || [])" :key="row._key+'-lic-'+i">
                    <span class="mr-1 px-1.5 py-0.5 bg-[#2d3748] rounded" x-text="l"></span>
                  </template>
                </td>
                <td class="px-4 py-2" :data-label="'Vuln ID'">
                  <template x-if="row.id">
                    <button class="underline text-[color:var(--primary)]" @click="applyTopCVE(row.id)"
                      x-text="row.id"></button>
                  </template>
                  <template x-if="!row.id">
                    <span>-</span>
                  </template>
                </td>
                <td class="px-4 py-2" :data-label="'Dataset'">
                  <span class="text-xs px-2 py-1 bg-[#2d3748] rounded inline-flex items-center gap-1">
                    <svg aria-hidden="true" viewBox="0 0 24 24" width="12" height="12" class="text-[#94a3b8]">
                      <path fill="currentColor"
                        d="M10 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6V4zm2 0v16h8a2 2 0 0 0 2-2V8l-6-4h-4z" />
                    </svg>
                    <span x-text="row.dataset"></span>
                  </span>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-[#94a3b8]">Page <span x-text="page+1"></span> / <span x-text="pages"></span></div>
        <div class="flex gap-2">
          <button
            class="px-4 py-2 border border-[#2d3748] rounded-lg disabled:opacity-50 bg-[#1a1f2e] text-[#e2e8f0] hover:bg-[#A1D6E2] hover:text-[#0a0e14] hover:border-[#A1D6E2]"
            :disabled="page===0" @click="prev()" aria-label="Previous page">Prev</button>
          <button
            class="px-4 py-2 border border-[#2d3748] rounded-lg disabled:opacity-50 bg-[#1a1f2e] text-[#e2e8f0] hover:bg-[#A1D6E2] hover:text-[#0a0e14] hover:border-[#A1D6E2]"
            :disabled="page+1>=pages" @click="next()" aria-label="Next page">Next</button>
        </div>
      </div>

      <div class="sm:hidden sticky-actions mt-3">
        <div class="grid grid-cols-3 gap-2 p-2">
          <button class="btn" @click="exportCSV()">Export</button>
          <button class="btn" @click="saveView()">Save</button>
          <button class="btn" @click="loadView()">Load</button>
        </div>
      </div>
    </section>
    </div>
    </div>
  </main>
</body>

</html>
