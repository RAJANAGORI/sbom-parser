<!doctype html>
<html lang="en" x-data="app()" x-init="init()" class="h-full bg-gray-50 antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SBOM Explorer</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Minimal, fast CDN libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>

  <style>
    /* Tailwind helpers via @apply for tiny custom classes */
    .card{ @apply bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-2xl shadow-sm p-4; }
    .muted{ @apply text-xs text-gray-500 dark:text-gray-400; }
    .bar { @apply h-2 w-full bg-gray-200 dark:bg-neutral-800 rounded; }
    .bar-fill { @apply h-2 rounded; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); }
    [x-cloak]{ display:none !important; }
    /* Respect users who prefer less motion */
    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }

    /* Responsive table → cards on small screens (no JS required) */
    @media (max-width: 768px) {
      table.responsive { display: block; border: 0; }
      table.responsive thead { display: none; }
      table.responsive tbody { display: grid; grid-template-columns: 1fr; gap: .75rem; padding: .75rem; }
      table.responsive tr { display: grid; border: 1px solid rgb(229 231 235); border-radius: .75rem; padding: .75rem; background: white; }
      table.responsive td { display: grid; grid-template-columns: 7rem 1fr; gap: .25rem; padding: .25rem 0; }
      table.responsive td::before { content: attr(data-label); @apply text-[11px] text-gray-500; }
      .sticky-actions { position: sticky; bottom: 0; padding-bottom: max(env(safe-area-inset-bottom),.5rem); background: linear-gradient(to top, rgba(255,255,255,.95), rgba(255,255,255,.6) 60%, transparent); backdrop-filter: blur(6px); }
      .btn { @apply h-11 px-4 rounded-xl border text-sm; }
    }
  </style>
</head>
<body class="h-full text-gray-900 dark:text-gray-100">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 bg-white/90 dark:bg-neutral-950/80 backdrop-blur border-b border-gray-200 dark:border-neutral-800">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 py-2 sm:py-3 flex items-center gap-2 sm:gap-3">
      <button class="sm:hidden p-2 rounded-xl border border-gray-200 dark:border-neutral-800" @click="mobileFilters=true" aria-label="Open filters">
        <!-- funnel icon -->
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 5h18M6 12h12M10 19h4"/></svg>
      </button>
      <h1 class="text-base sm:text-xl font-semibold">SBOM Explorer</h1>
      <span class="text-xs text-gray-500 ml-2" x-text="metaText" aria-live="polite"></span>

      <!-- Actions: become compact icons on mobile -->
      <div class="ml-auto flex items-center gap-1 sm:gap-2">
        <button class="hidden sm:inline px-3 py-2 border rounded-xl" @click="exportCSV()">Export CSV</button>
        <button class="hidden sm:inline px-3 py-2 border rounded-xl" @click="saveView()">Save View</button>
        <button class="hidden sm:inline px-3 py-2 border rounded-xl" @click="loadView()">Load View</button>

        <!-- Compact action menu on mobile -->
        <div class="sm:hidden relative" x-data="{open:false}" @keydown.escape.window="open=false">
          <button class="p-2 border rounded-xl" @click="open=!open" :aria-expanded="open.toString()" aria-haspopup="menu" aria-label="Actions">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="1.5"/><circle cx="5" cy="12" r="1.5"/><circle cx="19" cy="12" r="1.5"/></svg>
          </button>
          <div x-cloak x-show="open" @click.outside="open=false" class="absolute right-0 mt-2 w-44 bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-xl shadow-lg overflow-hidden">
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-neutral-800" @click="exportCSV(); open=false">Export CSV</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-neutral-800" @click="saveView(); open=false">Save View</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-neutral-800" @click="loadView(); open=false">Load View</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters (inline on desktop, drawer on mobile) -->
    <div class="max-w-7xl mx-auto px-3 sm:px-4 pb-2 sm:pb-3 hidden sm:flex items-center gap-2 flex-wrap">
      <!-- Search with typeahead -->
      <div class="relative w-full sm:w-80" x-ref="searchWrap">
        <label for="q" class="sr-only">Search components, purls, CVEs, or licenses</label>
        <input
          id="q"
          x-ref="search"
          x-model="q"
          @input="onInput"
          @keydown.down.prevent="moveSel(1)"
          @keydown.up.prevent="moveSel(-1)"
          @keydown.enter.prevent="applySel()"
          @keydown.escape.prevent="hideSuggest()"
          placeholder="Search (component, purl, vuln id, license)"
          class="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring"
          aria-autocomplete="list" :aria-expanded="(showSuggest && suggestions.length) ? 'true' : 'false'" aria-haspopup="listbox" inputmode="search" autocomplete="off"
        />
        <!-- suggestions -->
        <div
          x-ref="suggest"
          x-show="showSuggest && suggestions.length"
          @pointerdown.prevent
          class="absolute z-50 mt-1 w-full bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-xl shadow-lg max-h-72 overflow-auto"
          role="listbox"
        >
          <template x-for="(s, i) in suggestions" :key="s.key">
            <button
              type="button"
              @pointerdown.prevent
              @click="pick(s)"
              :class="['w-full text-left px-3 py-2 flex items-center gap-2', i===selIdx ? 'bg-blue-50 dark:bg-blue-900/20' : 'hover:bg-gray-50 dark:hover:bg-neutral-800']"
              :aria-selected="i===selIdx"
              role="option"
              style="min-height:44px"
            >
              <span class="text-[11px] px-1.5 py-0.5 rounded bg-gray-100 dark:bg-neutral-800" x-text="s.group"></span>
              <span class="truncate flex-1" x-text="s.label"></span>
              <span class="text-xs text-gray-400" x-text="s.meta"></span>
            </button>
          </template>
        </div>
      </div>

      <select x-model="dataset" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl min-w-[10rem]" aria-label="Filter by dataset">
        <option value="">All datasets</option>
        <template x-for="d in datasets" :key="d._key">
          <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
        </template>
      </select>

      <select x-model="severity" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl" aria-label="Filter by severity">
        <option value="">All severities</option>
        <template x-for="s in sevOpts" :key="s">
          <option :value="s" x-text="s"></option>
        </template>
      </select>

      <select x-model="fix" @change="applyFilters(true)" class="px-3 py-2 border rounded-xl" aria-label="Filter by fix availability">
        <option value="">Has fix?</option>
        <option value="has">Has fix</option>
        <option value="none">No fix</option>
      </select>

      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <span class="text-sm">CVSS ≥</span>
        <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin" @input="applyFilters(true)" class="w-20 outline-none" aria-label="Minimum CVSS" />
      </label>

      <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
        <input type="checkbox" x-model="onlyDirect" @change="applyFilters(true)" aria-label="Only direct dependencies">
        <span class="text-sm">Only direct</span>
      </label>

      <div class="ml-auto flex items-center gap-2">
        <label for="sortKey" class="sr-only">Sort</label>
        <select id="sortKey"
                x-model="sortKey"
                @change="applyFilters()"
                class="px-3 py-2 border rounded-xl"
                aria-label="Sort key">
          <option value="severityRank">Severity</option>
          <option value="cvss">CVSS</option>
          <option value="component">Component</option>
          <option value="dataset">Dataset</option>
        </select>

        <button class="px-3 py-2 border rounded-xl"
                @click="sortDir = sortDir==='desc' ? 'asc' : 'desc'; applyFilters()"
                :aria-label="'Sort ' + (sortDir==='desc' ? 'descending' : 'ascending')"
                x-text="sortDir==='desc' ? '↓' : '↑'">
        </button>

        <button class="px-3 py-2 border rounded-xl"
                @click="resetFilters()"
                aria-label="Reset all filters"
                title="Reset all filters">
          Reset
        </button>
      </div>
    </div>
  </header>

  <!-- Mobile filter drawer / sheet -->
  <div x-cloak x-show="mobileFilters" class="fixed inset-0 z-50 sm:hidden" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/30" @click="mobileFilters=false"></div>
    <section class="absolute inset-x-0 bottom-0 max-h-[85vh] bg-white dark:bg-neutral-950 border-t border-gray-200 dark:border-neutral-800 rounded-t-2xl shadow-lg flex flex-col">
      <header class="p-3 flex items-center gap-2">
        <div class="mx-auto h-1 w-10 rounded bg-gray-300"></div>
        <button class="ml-auto p-2 rounded-xl border" @click="mobileFilters=false" aria-label="Close filters">✕</button>
      </header>
      <div class="p-3 space-y-3 overflow-auto">
        <div class="relative">
          <label for="q-m" class="sr-only">Search</label>
          <input id="q-m" x-model="q" @input="onInput" placeholder="Search (component, purl, vuln id, license)" class="w-full px-3 py-3 border rounded-xl" inputmode="search" autocomplete="off" />
        </div>
        <div class="grid grid-cols-1 gap-3">
          <label class="text-xs text-gray-600">Dataset
            <select x-model="dataset" class="mt-1 w-full px-3 py-2 border rounded-xl">
              <option value="">All datasets</option>
              <template x-for="d in datasets" :key="d._key">
                <option :value="d.id" x-text="`${d.id} (${d.vulnerabilities})`"></option>
              </template>
            </select>
          </label>
          <label class="text-xs text-gray-600">Severity
            <select x-model="severity" class="mt-1 w-full px-3 py-2 border rounded-xl">
              <option value="">All severities</option>
              <template x-for="s in sevOpts" :key="s">
                <option :value="s" x-text="s"></option>
              </template>
            </select>
          </label>
          <label class="text-xs text-gray-600">Fix status
            <select x-model="fix" class="mt-1 w-full px-3 py-2 border rounded-xl">
              <option value="">Has fix?</option>
              <option value="has">Has fix</option>
              <option value="none">No fix</option>
            </select>
          </label>
          <div class="flex items-center gap-3">
            <label class="flex items-center gap-2 px-3 py-2 border rounded-xl flex-1">
              <span class="text-sm">CVSS ≥</span>
              <input type="number" min="0" max="10" step="0.1" x-model.number="cvssMin" class="w-20 outline-none" />
            </label>
            <label class="flex items-center gap-2 px-3 py-2 border rounded-xl">
              <input type="checkbox" x-model="onlyDirect">
              <span class="text-sm">Only direct</span>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Sort by
              <select x-model="sortKey" class="mt-1 w-full px-3 py-2 border rounded-xl">
                <option value="severityRank">Severity</option>
                <option value="cvss">CVSS</option>
                <option value="component">Component</option>
                <option value="dataset">Dataset</option>
              </select>
            </label>
            <button class="mt-6 px-3 py-2 border rounded-xl" @click="sortDir = sortDir==='desc'?'asc':'desc'">Sort <span x-text="sortDir==='desc'?'↓':'↑'"></span></button>
          </div>
        </div>
      </div>
      <div class="sticky-actions p-3 grid grid-cols-2 gap-2">
        <button class="btn" @click="applyFilters(true); mobileFilters=false">Apply</button>
        <button class="btn" @click="resetFilters(); mobileFilters=false">Reset</button>
      </div>
    </section>
  </div>

  <main class="max-w-7xl mx-auto px-3 sm:px-4 py-4 sm:py-6" x-cloak>
    <!-- Row 1: Totals (8/12) + Datasets (4/12) -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-3 sm:gap-4 mb-4 sm:mb-6" aria-live="polite">
      <!-- Left: totals + severities (6 equal tiles) -->
      <div class="lg:col-span-8 grid grid-cols-2 md:grid-cols-6 gap-3">
        <div class="card col-span-2">
          <div class="text-xs text-gray-500">Total vulnerabilities</div>
          <div class="text-2xl font-semibold" x-text="filtered.length"></div>
          <div class="muted mt-1" x-text="filterSummary"></div>
        </div>
        <template x-for="sev in ['CRITICAL','HIGH','MEDIUM','LOW']" :key="'sev-'+sev">
          <div class="card">
            <div class="text-xs text-gray-500" x-text="sev"></div>
            <div class="text-xl font-semibold" x-text="sevCountsFiltered[sev] || 0"></div>
          </div>
        </template>
      </div>

      <!-- Right: Datasets -->
      <div class="card lg:col-span-4">
        <div class="text-sm font-medium mb-3">Datasets in view</div>
        <template x-if="Object.keys(perDatasetSev).length === 0">
          <div class="muted">No datasets in the current view.</div>
        </template>
        <div class="space-y-3 max-h-60 overflow-auto">
          <template x-for="(v, name) in perDatasetSev" :key="'ds-'+name">
            <div>
              <div class="flex items-center justify-between text-sm">
                <div class="font-medium truncate" x-text="name"></div>
                <div class="text-xs text-gray-500" x-text="`${v.total} vulns`"></div>
              </div>
              <div class="bar"><div class="bar-fill" :style="`width:${Math.min(100, (v.total/Math.max(1, filtered.length))*100)}%`"></div></div>
              <div class="mt-1 flex flex-wrap gap-2 text-[11px] text-gray-600">
                <span>CRIT: <b x-text="v.CRITICAL||0"></b></span>
                <span>HIGH: <b x-text="v.HIGH||0"></b></span>
                <span>MED: <b x-text="v.MEDIUM||0"></b></span>
                <span>LOW: <b x-text="v.LOW||0"></b></span>
              </div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <!-- Row 2: Left analytics (8/12) + Right Top CVEs (4/12) -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-3 sm:gap-4 mb-4 sm:mb-6">
      <!-- Left analytics grid -->
      <div class="lg:col-span-8 grid gap-4 items-stretch [grid-template-columns:repeat(auto-fit,minmax(240px,1fr))]">
        <!-- Fix availability -->
        <div class="card h-full flex items-start gap-3" x-show="fixRateFiltered > 0">
          <div class="shrink-0">
            <svg viewBox="0 0 44 44" width="64" height="64" aria-label="Fix availability">
              <circle cx="22" cy="22" r="18" fill="none" stroke="#e5e7eb" stroke-width="6"/>
              <circle cx="22" cy="22" r="18" fill="none" :stroke-dasharray="ringCircumference" :stroke-dashoffset="ringOffsetFix" :stroke="fixRateFiltered ? ringColor : '#e5e7eb'" stroke-linecap="round" stroke-width="6" style="transform: rotate(-90deg); transform-origin: 50% 50%;"/>
            </svg>
          </div>
          <div>
            <div class="text-xs text-gray-500">Fix availability</div>
            <div class="text-2xl font-semibold" x-text="fixRateFiltered + '%' "></div>
            <div class="muted mt-1" x-text="fixRateFiltered ? '% of vulnerabilities with known fixes' : 'No known fixes in this view'"></div>
          </div>
        </div>

        <!-- Severity mix -->
        <div class="card h-full md:col-span-1 flex items-start gap-4">
          <div class="shrink-0">
            <svg viewBox="0 0 44 44" width="88" height="88" aria-label="Severity mix">
              <circle cx="22" cy="22" r="16" fill="none" class="text-gray-200 dark:text-neutral-800" stroke="currentColor" stroke-width="8"/>
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.CRITICAL.color" :stroke-dasharray="donutSegs.CRITICAL.dash" :stroke-dashoffset="donutSegs.CRITICAL.offset" stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.CRITICAL.count > 0"/>
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.HIGH.color" :stroke-dasharray="donutSegs.HIGH.dash" :stroke-dashoffset="donutSegs.HIGH.offset" stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.HIGH.count > 0"/>
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.MEDIUM.color" :stroke-dasharray="donutSegs.MEDIUM.dash" :stroke-dashoffset="donutSegs.MEDIUM.offset" stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.MEDIUM.count > 0"/>
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.LOW.color" :stroke-dasharray="donutSegs.LOW.dash" :stroke-dashoffset="donutSegs.LOW.offset" stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.LOW.count > 0"/>
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.INFO.color" :stroke-dasharray="donutSegs.INFO.dash" :stroke-dashoffset="donutSegs.INFO.offset" stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.INFO.count > 0"/>
              <circle cx="22" cy="22" r="16" fill="none" :stroke="donutSegs.UNKNOWN.color" :stroke-dasharray="donutSegs.UNKNOWN.dash" :stroke-dashoffset="donutSegs.UNKNOWN.offset" stroke-width="8" style="transform: rotate(-90deg); transform-origin: 50% 50%;" x-show="donutSegs.UNKNOWN.count > 0"/>
            </svg>
          </div>
          <div>
            <div class="text-sm font-medium mb-2">Severity mix</div>
            <div class="text-xs space-y-1">
              <template x-for="seg in donutLegend" :key="'leg-'+seg.label">
                <div class="flex items-center gap-2">
                  <span class="inline-block w-3 h-3 rounded" :style="`background:${seg.color}`"></span>
                  <span class="text-gray-600 dark:text-gray-300" x-text="`${seg.label}: ${seg.count}`"></span>
                </div>
              </template>
              <div class="muted mt-2" x-text="filterSummary"></div>
            </div>
          </div>
        </div>

        <!-- Top components -->
        <div class="card h-full">
          <div class="text-sm font-medium mb-2">Top components by vulnerabilities</div>
          <div class="space-y-2">
            <template x-for="row in topComponents" :key="'tc-'+row.name">
              <div class="flex items-center gap-3">
                <div class="w-36 truncate text-xs text-gray-700 dark:text-gray-300" :title="row.name" x-text="row.name"></div>
                <div class="flex-1 h-2 bg-gray-200 dark:bg-neutral-800 rounded"><div class="h-2 rounded" :style="`width:${row.pct}%; background:#10b981`"></div></div>
                <div class="w-8 text-right text-xs text-gray-500" x-text="row.count"></div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Right: Top CVEs -->
      <div class="card lg:col-span-4 h-full">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">Top CVEs</div>
          <button class="text-xs underline" @click="applyTopCVE()">Clear filter</button>
        </div>
        <template x-if="!(metrics.topCVEs||[]).length">
          <div class="muted">No CVE IDs found.</div>
        </template>
        <ul class="text-sm grid grid-cols-1 gap-3 max-h-80 overflow-auto">
          <template x-for="cve in (metrics.topCVEs || [])" :key="'cve-'+cve.id">
            <li class="border rounded-xl p-3">
              <div class="font-medium">
                <button class="text-blue-600 underline" @click="applyTopCVE(cve.id)" x-text="cve.id"></button>
              </div>
              <div class="muted mt-1">
                <span x-text="`Count: ${cve.count}`"></span>
                · <span x-text="`Max CVSS: ${cve.maxCVSS ?? '-'}`"></span>
                <template x-if="(cve.datasets||[]).length">· <span x-text="`Datasets: ${cve.datasets.join(', ')}`"></span></template>
              </div>
            </li>
          </template>
        </ul>
      </div>
    </section>

    <!-- Row 3: Remaining analytics -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
      <!-- CVSS distribution -->
      <div class="card h-full">
        <div class="text-sm font-medium mb-2">CVSS distribution</div>
        <svg :viewBox="`0 0 ${sparkW} ${sparkH}`" :width="sparkW" :height="sparkH" role="img" aria-label="CVSS sparkline">
          <polyline :points="sparkGrid" fill="none" stroke="#e5e7eb" stroke-width="1"/>
          <polyline :points="cvssPath" fill="none" stroke="#2563eb" stroke-width="2"/>
        </svg>
        <div class="muted mt-2" x-text="cvssStatsText"></div>
      </div>

      <!-- Top license analytics -->
      <div class="card">
        <div class="text-sm font-medium mb-2">Top licenses by vulnerabilities</div>
        <div class="space-y-2">
          <template x-for="row in topLicenses" :key="'tl-'+row.name">
            <div class="flex items-center gap-3">
              <div class="w-36 truncate text-xs text-gray-700 dark:text-gray-300" :title="row.name" x-text="row.name"></div>
              <div class="flex-1 h-2 bg-gray-200 dark:bg-neutral-800 rounded"><div class="h-2 rounded" :style="`width:${row.pct}%; background:#6366f1`"></div></div>
              <div class="w-8 text-right text-xs text-gray-500" x-text="row.count"></div>
            </div>
          </template>
          <template x-if="!topLicenses.length"><div class="muted">No license data</div></template>
        </div>
      </div>

      <!-- Fix rate by dataset -->
      <div class="card">
        <div class="text-sm font-medium mb-2">Fix availability by dataset</div>
        <div class="space-y-2">
          <template x-for="row in dsFixRates" :key="'dsfr-'+row.name">
            <div class="flex items-center gap-3">
              <div class="w-32 truncate text-xs text-gray-700 dark:text-gray-300" :title="row.name" x-text="row.name"></div>
              <div class="flex-1 h-2 bg-gray-200 dark:bg-neutral-800 rounded">
                <div class="h-2 rounded" :style="`width:${row.rate}%; background:${row.rate>=67?'#10b981':row.rate>=33?'#f59e0b':'#ef4444'}`"></div>
              </div>
              <div class="w-10 text-right text-xs text-gray-500" x-text="row.rate + '%' "></div>
            </div>
          </template>
        </div>
      </div>
    </section>

    <!-- Vulnerabilities table / cards -->
    <section>
      <div class="mb-2 text-sm text-gray-600 dark:text-gray-300">
        <span x-text="`Showing ${filtered.length} of ${items.length} vulnerabilities`"></span>
      </div>
      <div class="overflow-x-auto bg-white dark:bg-neutral-900 border border-gray-200 dark:border-neutral-800 rounded-2xl shadow-sm">
        <table class="min-w-full text-sm responsive">
          <thead class="bg-gray-50 dark:bg-neutral-900/60">
            <tr class="text-left">
              <th class="px-4 py-3">Severity</th>
              <th class="px-4 py-3">CVSS</th>
              <th class="px-4 py-3">Component</th>
              <th class="px-4 py-3">Version</th>
              <th class="px-4 py-3">License</th>
              <th class="px-4 py-3">Vuln ID</th>
              <th class="px-4 py-3 w-40">Dataset</th>
              <th class="px-4 py-3 w-40">Links</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="row in paged" :key="row._key">
              <tr class="border-t hover:bg-gray-50 dark:hover:bg-neutral-800/60">
                <td class="px-4 py-2" :data-label="'Severity'">
                  <span class="px-2 py-0.5 rounded-lg text-xs font-semibold" :class="badge(row.severity)" x-text="row.severity || 'UNKNOWN'"></span>
                </td>
                <td class="px-4 py-2" :data-label="'CVSS'" x-text="row.cvss ?? '-' "></td>
                <td class="px-4 py-2" :data-label="'Component'">
                  <div class="font-medium" x-text="row.component || '-' "></div>
                  <div class="text-xs text-gray-500 truncate max-w-[28rem]" x-text="row.purl"></div>
                </td>
                <td class="px-4 py-2" :data-label="'Version'" x-text="row.version || '-' "></td>
                <td class="px-4 py-2" :data-label="'License'">
                  <template x-for="(l,i) in (row.licenses || [])" :key="row._key+'-lic-'+i">
                    <span class="mr-1 px-1.5 py-0.5 bg-gray-100 dark:bg-neutral-800 rounded" x-text="l"></span>
                  </template>
                </td>
                <td class="px-4 py-2" :data-label="'Vuln ID'" x-text="row.id || '-' "></td>
                <td class="px-4 py-2" :data-label="'Dataset'">
                  <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-neutral-800 rounded" x-text="row.dataset"></span>
                  <template x-if="row.direct"><span class="ml-1 text-[10px] px-1 py-0.5 bg-emerald-100 text-emerald-700 rounded">direct</span></template>
                </td>
                <td class="px-4 py-2" :data-label="'Links'">
                  <template x-for="(u,i) in (row.urls || [])" :key="row._key+'-url-'+i">
                    <a class="text-blue-600 underline mr-2" :href="u" target="_blank" rel="noopener" x-text="`ref${i+1}`"></a>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Pagination: bigger tap targets on mobile -->
      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600 dark:text-gray-300">Page <span x-text="page+1"></span> / <span x-text="pages"></span></div>
        <div class="flex gap-2">
          <button class="px-4 py-2 border rounded-lg disabled:opacity-50" :disabled="page===0" @click="prev()" aria-label="Previous page">Prev</button>
          <button class="px-4 py-2 border rounded-lg disabled:opacity-50" :disabled="page+1>=pages" @click="next()" aria-label="Next page">Next</button>
        </div>
      </div>

      <!-- Mobile sticky actions for quick access -->
      <div class="sm:hidden sticky-actions mt-3">
        <div class="grid grid-cols-3 gap-2 p-2">
          <button class="btn" @click="exportCSV()">Export</button>
          <button class="btn" @click="saveView()">Save</button>
          <button class="btn" @click="loadView()">Load</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    function app(){
      return {
        // state from parse-sboms.json
        items: [],
        filtered: [],
        paged: [],
        datasets: [],
        overall: { total: 0, severityCounts: {} },
        metrics: { fixAvailabilityRate:0, topCVEs:[] },
        // filters
        dataset: "",
        q: "",
        severity: "",
        fix: "",
        cvssMin: 0,
        onlyDirect: false,
        mobileFilters: false,
        // severity dropdown (dynamic)
        sevBaseOrder: ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN'],
        sevOpts: ['CRITICAL','HIGH','MEDIUM','LOW'],
        // derived (filtered)
        sevCountsFiltered: {},
        fixRateFiltered: 0,
        filterSummary: "",
        perDatasetSev: {},
        // sort/paging
        sortKey: "severityRank",
        sortDir: "desc",
        page: 0,
        perPage: (matchMedia('(max-width: 640px)').matches ? 20 : 50), // smaller pages on phones
        pages: 0,
        metaText: "",

        /* ------- typeahead state ------- */
        suggestions: [],
        showSuggest: false,
        selIdx: -1,
        _suggestTimer: null,

        hideSuggest(){ this.showSuggest=false; this.selIdx=-1; },
        moveSel(step){
          if (!this.suggestions.length) return;
          const n = this.suggestions.length;
          this.selIdx = ( (this.selIdx + step + n) % n );
        },
        applySel(){
          if (this.selIdx < 0 || this.selIdx >= this.suggestions.length) { this.hideSuggest(); return; }
          this.pick(this.suggestions[this.selIdx]);
        },
        pick(s){
          this.q = s.query;
          this.applyFilters(true);
          this.hideSuggest();
          this.$nextTick(() => this.$refs.search?.focus());
        },
        onInput(e){
          this.q = e.target.value;
          this.applyFilters(true);
          clearTimeout(this._suggestTimer);
          const val = this.q.trim();
          if (!val){ this.suggestions=[]; this.hideSuggest(); return; }
          this._suggestTimer = setTimeout(() => this.updateSuggestions(val), 120); // slightly more debounce for mobile
        },
        updateSuggestions(val){
          const q = val.toLowerCase();
          const cand = [];
          const seen = new Set();
          const push = (group, label, query, meta='') => {
            const key = group + '|' + label;
            if (seen.has(key)) return;
            seen.add(key);
            cand.push({ key, group, label, query, meta });
          };

          for (const r of this.items){
            if (r.component && r.component.toLowerCase().includes(q))
              push('component', r.component, r.component, r.version||'');
            if (r.id && r.id.toLowerCase().includes(q))
              push('vuln id', r.id, r.id, r.severity||'');
            if (r.purl && r.purl.toLowerCase().includes(q))
              push('purl', r.purl, r.purl.split('@')[0] || r.purl, r.version||'');
            for (const L of (r.licenses||[])){
              if (L && L.toLowerCase().includes(q)) push('license', L, L, '');
            }
            if (r.dataset && r.dataset.toLowerCase().includes(q))
              push('dataset', r.dataset, r.dataset, '');
          }

          const starts = [], contains = [];
          for (const s of cand){ (s.label.toLowerCase().startsWith(q) ? starts : contains).push(s); }
          const byLen = a => a.sort((x,y)=>x.label.length - y.label.length);
          this.suggestions = [...byLen(starts), ...byLen(contains)].slice(0, 12);
          this.showSuggest = this.suggestions.length > 0;
          this.selIdx = this.suggestions.length ? 0 : -1;
        },

        /* ------- micro-chart helpers ------- */
        ringCircumference: 2 * Math.PI * 18, // r=18
        get ringOffsetFix(){
          const pct = Math.max(0, Math.min(100, this.fixRateFiltered)) / 100;
          return this.ringCircumference * (1 - pct);
        },
        get ringColor(){
          const p = this.fixRateFiltered;
          if (p >= 67) return '#10b981';
          if (p >= 33) return '#f59e0b';
          return '#ef4444';
        },

        donutSegs: {
          CRITICAL:{dash:'0 1000', offset:0, color:'#dc2626', count:0},
          HIGH:{dash:'0 1000', offset:0, color:'#f87171', count:0},
          MEDIUM:{dash:'0 1000', offset:0, color:'#f59e0b', count:0},
          LOW:{dash:'0 1000', offset:0, color:'#10b981', count:0},
          INFO:{dash:'0 1000', offset:0, color:'#9ca3af', count:0},
          UNKNOWN:{dash:'0 1000', offset:0, color:'#d1d5db', count:0},
        },
        donutLegend: [],
        buildSeverityDonut(){
          const order = this.sevBaseOrder;
          const counts = this.sevCountsFiltered || {};
          const total = Object.values(counts).reduce((a,b)=>a+(b||0),0) || 0;
          const r = 16, C = 2 * Math.PI * r;
          let acc = 0;
          this.donutLegend = [];
          for (const k of order){
            this.donutSegs[k].dash = `0 ${C.toFixed(2)}`;
            this.donutSegs[k].offset = 0;
            this.donutSegs[k].count = 0;
          }
          for (const label of order){
            const count = counts[label] || 0;
            if (!count) continue;
            const pct = count / Math.max(1, total);
            const segLen = pct * C;
            this.donutSegs[label].dash = `${segLen.toFixed(2)} ${(C - segLen).toFixed(2)}`;
            this.donutSegs[label].offset = (C * (1 - acc)).toFixed(2);
            this.donutSegs[label].count = count;
            acc += pct;
            this.donutLegend.push({ label, color: this.donutSegs[label].color, count });
          }
        },

        // sparkline
        sparkW: 360,
        sparkH: 64,
        cvssPath: "",
        sparkGrid: "",
        cvssStatsText: "",
        buildCvssSpark(){
          const w=this.sparkW, h=this.sparkH, pad=6;
          const xs = this.filtered.map(r=>typeof r.cvss==='number'?r.cvss:null).filter(v=>v!=null);
          const n=xs.length;
          this.sparkGrid = `0,${h-1} ${w},${h-1} 0,${Math.round(h/2)} ${w},${Math.round(h/2)} 0,1 ${w},1`;
          if (!n){ this.cvssPath=""; this.cvssStatsText="no scores"; return; }
          const sorted=[...xs].sort((a,b)=>a-b);
          const min=sorted[0];
          const q = (p)=>sorted[Math.floor((sorted.length-1)*p)];
          const med=q(0.5).toFixed(1);
          const step = Math.max(1, Math.floor(n/80));
          const vals = xs.filter((_,i)=>i%step===0);
          const m = vals.length;
          const scaleX=(i)=> pad + (i/(m-1))*(w-2*pad);
          const scaleY=(v)=> pad + (1-((v-0)/10))*(h-2*pad);
          this.cvssPath = vals.map((v,i)=>`${scaleX(i)},${scaleY(v)}`).join(' ');
          this.cvssStatsText = `n=${n} · min=${min?.toFixed(1)} · med=${med} · p90=${q(0.9).toFixed(1)}`;
        },

        // top components micro bars
        topComponents: [],
        buildTopComponents(){
          const counts = {};
          for (const r of this.filtered){
            const name = r.component || 'unknown';
            counts[name] = (counts[name]||0)+1;
          }
          const arr = Object.entries(counts).map(([name,count])=>({name,count}));
          arr.sort((a,b)=>b.count-a.count);
          const top = arr.slice(0,6);
          const max = top[0]?.count || 1;
          this.topComponents = top.map(x=>({ ...x, pct: Math.round(100*x.count/max) }));
        },

        // top licenses micro bars
        topLicenses: [],
        buildTopLicenses(){
          const counts = {};
          for (const r of this.filtered){
            const ls = Array.isArray(r.licenses) ? r.licenses : [];
            if (!ls.length) continue;
            for (const L of ls){
              const name = (L||'unknown').trim() || 'unknown';
              counts[name] = (counts[name]||0)+1;
            }
          }
          const arr = Object.entries(counts).map(([name,count])=>({name,count}));
          arr.sort((a,b)=>b.count-a.count);
          const top = arr.slice(0,6);
          const max = top[0]?.count || 1;
          this.topLicenses = top.map(x=>({ ...x, pct: Math.round(100*x.count/max) }));
        },

        // fix rate by dataset
        dsFixRates: [],
        buildDsFixRates(){
          const map = {};
          for (const r of this.filtered){
            const d = r.dataset || 'unknown';
            if (!map[d]) map[d] = {name:d, total:0, fix:0};
            map[d].total++;
            if ((r.fixedVersions||[]).length) map[d].fix++;
          }
          const rows = Object.values(map).map(x=>({ name: x.name, rate: x.total ? Math.round(100*x.fix/x.total) : 0 }));
          rows.sort((a,b)=>b.rate-a.rate);
          this.dsFixRates = rows.slice(0,6);
        },

        // replacement card data for 0% fix-rate
        noFixSevBars: [],
        buildNoFixBars(){
          const nf = this.filtered.filter(r => !(r.fixedVersions||[]).length);
          const counts = this.countSev(nf);
          const total = nf.length || 1;
          const order = ['CRITICAL','HIGH','MEDIUM','LOW','INFO','UNKNOWN'];
          this.noFixSevBars = order
            .filter(s => counts[s])
            .map(s => ({ label: s, count: counts[s], pct: Math.round(100 * counts[s] / total), color: this.donutSegs[s].color }));
        },

        // dropdown options
        updateSeverityOptions(){
          const q = this.q.trim().toLowerCase();
          const ds = this.dataset, fix = this.fix, cv = Number(this.cvssMin)||0;
          const only = this.onlyDirect;
          const base = this.items.filter(r => {
            if (ds && r.dataset !== ds) return false;
            if (only && !r.direct) return false;
            if (cv && (r.cvss ?? -1) < cv) return false;
            if (fix === 'has' && !(r.fixedVersions||[]).length) return false;
            if (fix === 'none' && (r.fixedVersions||[]).length) return false;
            if (q){
              const t=[r.component,r.purl,r.id,(r.licenses||[]).join(' '),(r.dataset||'')].join(' ').toLowerCase();
              if (!t.includes(q)) return false;
            }
            return true;
          });
          const c = this.countSev(base);
          const out = ['CRITICAL','HIGH','MEDIUM','LOW'];
          if ((c.INFO||0) > 0) out.push('INFO');
          if ((c.UNKNOWN||0) > 0) out.push('UNKNOWN');
          this.sevOpts = out;
        },

        async init(){
          const snap = await fetch("./parse-sboms.json?_=" + Date.now()).then(r => r.json());
          this.items = (snap.items || []).map((r, idx) => ({ ...r, _key: (r.dataset || 'ds') + '::' + (r.id || (r.component || 'comp') + '@' + (r.version || '')) + '::' + idx }));
          this.datasets = (snap.datasets || [])
            .map((d, i) => ({ ...d, _key: 'ds-' + (d.id || i) }))
            .sort((a,b)=>String(a.id).localeCompare(String(b.id)));
          this.overall = snap.overall || this.overall;
          this.metrics = snap.metrics || this.metrics;
          this.metaText = snap.generatedAt ? `updated ${new Date(snap.generatedAt).toLocaleString()}` : '';

          this.restoreFromHash();
          this.updateSeverityOptions();
          this.applyFilters(true);

          // click/tap outside -> close suggestions, but allow taps inside the panel
          document.addEventListener('click', (e)=>{
            const wrap = this.$refs.searchWrap;
            const panel = this.$refs.suggest;
            if (!wrap) return;
            const t = e.target;
            const insideWrap = wrap.contains(t);
            const insidePanel = panel ? panel.contains(t) : false;
            if (!insideWrap && !insidePanel) this.hideSuggest();
          }, { capture: true });

          // Build non-critical charts after idle (snappier on low-end phones)
          const idle = window.requestIdleCallback || ((fn)=>setTimeout(fn, 120));
          idle(()=>{ this.buildTopComponents(); this.buildTopLicenses(); this.buildDsFixRates(); });
        },

        // utils
        badge(sev){
          const s = (sev||"").toUpperCase();
          const base = "px-2 py-0.5 rounded-lg text-xs font-semibold";
          if (s==="CRITICAL") return base+" bg-red-600 text-white";
          if (s==="HIGH") return base+" bg-red-200 text-red-800";
          if (s==="MEDIUM") return base+" bg-amber-100 text-amber-800";
          if (s==="LOW") return base+" bg-green-100 text-green-800";
          return base+" bg-gray-100 text-gray-800";
        },

        applyFilters(buildGroup=false){
          const q = this.q.trim().toLowerCase();
          const sev = this.severity, fix = this.fix, cv = Number(this.cvssMin) || 0, ds = this.dataset;
          this.filtered = this.items.filter(r => {
            if (ds && r.dataset !== ds) return false;
            if (sev && (r.severity||"").toUpperCase() !== sev) return false;
            if (this.onlyDirect && !r.direct) return false;
            if (cv && (r.cvss ?? -1) < cv) return false;
            if (fix === "has" && !(r.fixedVersions || []).length) return false;
            if (fix === "none" && (r.fixedVersions || []).length) return false;
            if (q) {
              const t = [r.component, r.purl, r.id, (r.licenses||[]).join(" "), (r.dataset||"")].join(" ").toLowerCase();
              if (!t.includes(q)) return false;
            }
            return true;
          });

          // sorting
          const key = this.sortKey;
          const dir = this.sortDir === "desc" ? -1 : 1;
          this.filtered.sort((a,b)=>{
            const A = (a[key] ?? ""), B = (b[key] ?? "");
            if (typeof A === "number" && typeof B === "number") return (A-B)*dir;
            return String(A).localeCompare(String(B)) * dir;
          });

          // paginate
          this.page = 0;
          this.paginate();

          // derive view metrics
          this.sevCountsFiltered = this.countSev(this.filtered);
          const hasFix = this.filtered.filter(r => (r.fixedVersions||[]).length).length;
          this.fixRateFiltered = this.filtered.length ? Math.round(100 * (hasFix/this.filtered.length)) : 0;
          this.perDatasetSev = this.groupByDatasetSev(this.filtered);
          this.filterSummary = this.buildFilterSummary();

          // charts / analytics
          this.buildSeverityDonut();
          this.buildCvssSpark();
          this.buildTopComponents();
          this.buildTopLicenses();
          this.buildDsFixRates();
          this.buildNoFixBars();

          // refresh dropdown options
          this.updateSeverityOptions();
          this.persistToHash();
        },

        buildLicensesIfNeeded(){ this.buildTopLicenses(); },

        paginate(){
          this.pages = Math.max(1, Math.ceil(this.filtered.length / this.perPage));
          const start = this.page * this.perPage;
          this.paged = this.filtered.slice(start, start + this.perPage);
        },
        next(){ if (this.page+1 < this.pages){ this.page++; this.paginate(); this.persistToHash(); } },
        prev(){ if (this.page>0){ this.page--; this.paginate(); this.persistToHash(); } },

        // helpers
        countSev(list){
          const out = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,UNKNOWN:0};
          for (const r of list){
            const s=(r.severity||'UNKNOWN').toUpperCase();
            out[s]=(out[s]||0)+1;
          }
          return out;
        },
        groupByDatasetSev(list){
          const map = {};
          for (const r of list){
            const ds = r.dataset || 'unknown';
            if (!map[ds]) map[ds] = {CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0,INFO:0,UNKNOWN:0,total:0};
            const s=(r.severity||'UNKNOWN').toUpperCase();
            map[ds][s] = (map[ds][s]||0)+1;
            map[ds].total++;
          }
          return map;
        },
        buildFilterSummary(){
          const bits = [];
          if (this.dataset) bits.push(`dataset=${this.dataset}`);
          if (this.severity) bits.push(`severity=${this.severity}`);
          if (this.fix) bits.push(`fix=${this.fix}`);
          if (this.cvssMin) bits.push(`cvss≥${this.cvssMin}`);
          if (this.onlyDirect) bits.push('onlyDirect');
          if (this.q) bits.push(`q="${this.q}"`);
          return bits.length ? `Active: ${bits.join(' · ')}` : 'No active filters';
        },

        // CSV export
        exportCSV(){
          const rows = this.filtered;
          if (!rows.length) { alert("No rows to export."); return; }
          const header = ["severity","cvss","component","version","purl","licenses","id","dataset","links","direct"];
          const lines = [header.join(",")];
          for (const r of rows) {
            const csv = [
              r.severity ?? "",
              r.cvss ?? "",
              r.component ?? "",
              r.version ?? "",
              r.purl ?? "",
              (r.licenses||[]).join("|"),
              r.id ?? "",
              r.dataset ?? "",
              (r.urls||[]).join("|"),
              r.direct ? "yes" : "no"
            ].map(x => `"${String(x).replace(/"/g,'""')}"`).join(",");
            lines.push(csv);
          }
          const blob = new Blob([lines.join("\n")], {type: "text/csv;charset=utf-8;"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "sbom-filtered.csv";
          a.click();
          URL.revokeObjectURL(url);
        },

        // URL state
        persistToHash(){
          const h = new URLSearchParams({
            q: this.q || "",
            ds: this.dataset || "",
            sev: this.severity || "",
            fix: this.fix || "",
            cvss: String(this.cvssMin || 0),
            dir: this.sortDir,
            key: this.sortKey,
            dirc: this.onlyDirect ? "1" : "0",
            p: String(this.page)
          }).toString();
          location.hash = h;
        },
        restoreFromHash(){
          const s = new URLSearchParams(location.hash.replace(/^#/, ""));
          this.q = s.get("q") || this.q;
          this.dataset = s.get("ds") || this.dataset;
          this.severity = s.get("sev") || this.severity;
          this.fix = s.get("fix") || this.fix;
          this.cvssMin = Number(s.get("cvss") || this.cvssMin || 0);
          this.sortDir = s.get("dir") || this.sortDir;
          this.sortKey = s.get("key") || this.sortKey;
          this.onlyDirect = s.get("dirc")==="1" ? true : this.onlyDirect;
          this.page = Number(s.get("p") || this.page || 0);
        },

        // Top CVE helper
        applyTopCVE(id){ this.q = id || ""; this.applyFilters(true); },

        // Reset helper (used by desktop button and mobile sheet)
        resetFilters(){
          this.q = "";
          this.dataset = "";
          this.severity = "";
          this.fix = "";
          this.cvssMin = 0;
          this.onlyDirect = false;
          this.sortKey = "severityRank";
          this.sortDir = "desc";
          this.page = 0;
          this.updateSeverityOptions();
          this.applyFilters(true);
        },

        // tiny helpers for view save/load
        saveView(){ try{ localStorage.setItem('sbom_view', location.hash); alert('View saved.'); }catch{} },
        loadView(){ try{ const h = localStorage.getItem('sbom_view'); if(h){ location.hash=h; this.restoreFromHash(); this.applyFilters(true);} }catch{} }
      }
    }
  </script>
</body>
</html>
