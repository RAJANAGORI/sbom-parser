<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBOM Explorer</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            critical: "#ef4444",
            high: "#f97316",
            medium: "#eab308",
            low: "#22c55e",
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js for donut + tiny trends -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <style>
    html,body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .badge { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    .badge-critical { @apply bg-red-50 text-red-700 ring-1 ring-inset ring-red-200; }
    .badge-high { @apply bg-orange-50 text-orange-700 ring-1 ring-inset ring-orange-200; }
    .badge-medium { @apply bg-yellow-50 text-yellow-800 ring-1 ring-inset ring-yellow-200; }
    .badge-low { @apply bg-green-50 text-green-700 ring-1 ring-inset ring-green-200; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 shadow-sm; }
    .btn-primary { @apply bg-slate-900 text-white border-slate-900 hover:bg-black; }
    .chip { @apply inline-flex items-center gap-1 rounded-full border px-2 py-1 text-xs font-medium cursor-pointer select-none; }
    .chip-active { @apply bg-slate-900 text-white border-slate-900; }
    .tab { @apply px-4 py-2 text-sm font-medium rounded-lg cursor-pointer; }
    .tab-active { @apply bg-slate-900 text-white; }
    .card { @apply rounded-2xl border border-slate-200 bg-white shadow-sm; }
    .grid-auto { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 1rem; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Top bar -->
  <header class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-slate-900 text-white font-bold">S</span>
        <h1 class="text-lg font-semibold tracking-tight">SBOM Explorer</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="exportCsvBtn" class="btn" title="Export filtered vulnerabilities to CSV">Export CSV</button>
        <button id="saveViewBtn" class="btn" title="Save current filters">Save View</button>
        <button id="loadViewBtn" class="btn" title="Load saved filters">Load View</button>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <section class="mx-auto max-w-7xl px-4 py-4">
    <div class="card p-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div class="flex flex-1 flex-col gap-2 md:max-w-xl">
          <label class="text-xs font-medium text-slate-500">Search (component, purl, vuln id, license)</label>
          <input id="searchInput" type="search" placeholder="Search…" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-300">
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="text-xs font-medium text-slate-500">Datasets</label>
            <select id="datasetSelect" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
              <option value="">All datasets</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-slate-500">Severity</label>
            <select id="severitySelect" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
              <option value="">All severities</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-slate-500">Fix status</label>
            <select id="fixSelect" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
              <option value="">Any</option>
              <option value="hasfix">Has fix</option>
              <option value="nofix">No fix</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-slate-500">CVSS ≥</label>
            <input id="cvssMinInput" type="number" step="0.1" min="0" max="10" value="0" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
          </div>
        </div>

        <label class="inline-flex items-center gap-2 self-start md:self-auto">
          <input id="onlyDirectChk" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-500">
          <span class="text-sm">Only direct</span>
        </label>
      </div>

      <!-- quick chips -->
      <div class="mt-3 flex flex-wrap gap-2">
        <span data-chip="critical" class="chip">Critical</span>
        <span data-chip="high" class="chip">High</span>
        <span data-chip="hasfix" class="chip">Has Fix</span>
        <span data-chip="direct" class="chip">Direct</span>
        <button id="resetBtn" class="ml-auto btn">Reset</button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="mx-auto max-w-7xl px-4">
    <div class="grid-auto">
      <div class="card p-4">
        <p class="text-xs text-slate-500">Total Vulnerabilities</p>
        <p id="kpiTotal" class="mt-1 text-3xl font-semibold">0</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">Severity distribution</p>
        <div class="mt-2 h-36">
          <canvas id="severityPie"></canvas>
        </div>
        <div class="mt-3 flex gap-2 text-xs">
          <span class="badge badge-critical">Critical <span id="kpiCritical" class="ml-1 font-semibold">0</span></span>
          <span class="badge badge-high">High <span id="kpiHigh" class="ml-1 font-semibold">0</span></span>
          <span class="badge badge-medium">Medium <span id="kpiMedium" class="ml-1 font-semibold">0</span></span>
          <span class="badge badge-low">Low <span id="kpiLow" class="ml-1 font-semibold">0</span></span>
        </div>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">Fix availability rate</p>
        <p class="mt-1 text-3xl font-semibold"><span id="kpiFixRate">0</span>%</p>
        <p class="mt-2 text-xs text-slate-500">% of current vulns with known fixes</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">Median time to fix</p>
        <p id="kpiMTTR" class="mt-1 text-2xl font-semibold">—</p>
        <p class="mt-2 text-xs text-slate-500">Across vulns that disappeared since first seen</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-slate-500">Median open age</p>
        <p id="kpiOpenAge" class="mt-1 text-2xl font-semibold">0 days</p>
        <p class="mt-2 text-xs text-slate-500">How long current vulns have been present</p>
      </div>
    </div>
  </section>

  <!-- Top CVEs -->
  <section class="mx-auto max-w-7xl px-4 py-4">
    <div class="card p-4">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Top CVEs (by severity & count)</h2>
        <button id="clearCveFilter" class="btn text-xs">Clear</button>
      </div>
      <ul id="topCvesList" class="mt-3 grid gap-2 sm:grid-cols-2 lg:grid-cols-3"></ul>
    </div>
  </section>

  <!-- Tabs -->
  <section class="mx-auto max-w-7xl px-4">
    <div class="flex gap-2">
      <button data-tab="vulns" class="tab tab-active">Vulnerabilities</button>
      <button data-tab="components" class="tab">Components</button>
      <button data-tab="compare" class="tab">Compare datasets</button>
    </div>

    <!-- Vulns table -->
    <div id="tab-vulns" class="mt-4 card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-left text-slate-600">
            <tr>
              <th class="px-4 py-2">Severity</th>
              <th class="px-4 py-2">CVSS</th>
              <th class="px-4 py-2">Component</th>
              <th class="px-4 py-2">Version</th>
              <th class="px-4 py-2">License</th>
              <th class="px-4 py-2">Vuln ID</th>
              <th class="px-4 py-2">Dataset</th>
              <th class="px-4 py-2">Links</th>
              <th class="px-4 py-2">first seen</th>
              <th class="px-4 py-2">direct — refs</th>
            </tr>
          </thead>
          <tbody id="vulnTbody" class="divide-y divide-slate-100 bg-white"></tbody>
        </table>
      </div>

      <div class="flex items-center justify-between border-t px-4 py-3 text-sm">
        <div>Page <span id="pageNum">1</span> / <span id="pageCount">1</span></div>
        <div class="flex gap-2">
          <button id="prevPageBtn" class="btn">Prev</button>
          <button id="nextPageBtn" class="btn">Next</button>
        </div>
      </div>
    </div>

    <!-- Components table -->
    <div id="tab-components" class="mt-4 hidden">
      <div class="card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-left text-slate-600">
              <tr>
                <th class="px-4 py-2">Component</th>
                <th class="px-4 py-2">Worst Severity</th>
                <th class="px-4 py-2">Max CVSS</th>
                <th class="px-4 py-2">Vuln Count</th>
                <th class="px-4 py-2">Datasets</th>
                <th class="px-4 py-2">Licenses</th>
              </tr>
            </thead>
            <tbody id="compTbody" class="divide-y divide-slate-100 bg-white"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Compare -->
    <div id="tab-compare" class="mt-4 hidden">
      <div class="card p-4">
        <div class="grid gap-3 sm:grid-cols-3">
          <select id="cmpA" class="rounded-xl border border-slate-300 px-3 py-2 text-sm"><option value="">Pick Dataset A</option></select>
          <select id="cmpB" class="rounded-xl border border-slate-300 px-3 py-2 text-sm"><option value="">Pick Dataset B</option></select>
          <button id="runCompareBtn" class="btn">Compare</button>
        </div>

        <div class="mt-4 grid gap-4 lg:grid-cols-3">
          <div class="card p-4">
            <p class="text-xs text-slate-500">Total:</p>
            <p class="text-2xl font-semibold" id="cmpTotalA">0</p>
            <p class="mt-2 text-xs text-slate-500" id="cmpBreakA"></p>
          </div>
          <div class="card p-4">
            <p class="text-xs text-slate-500">Total:</p>
            <p class="text-2xl font-semibold" id="cmpTotalB">0</p>
            <p class="mt-2 text-xs text-slate-500" id="cmpBreakB"></p>
          </div>
          <div class="card p-4">
            <p class="text-xs text-slate-500">Delta (B − A)</p>
            <p class="text-2xl font-semibold" id="cmpDelta">0</p>
            <div class="mt-2 text-xs text-slate-500 grid gap-1">
              <div>Only in <span id="cmpOnlyBLabel" class="font-medium">B</span></div>
              <ul id="cmpOnlyB" class="list-disc pl-4"></ul>
              <div class="mt-2">Only in <span id="cmpOnlyALabel" class="font-medium">A</span></div>
              <ul id="cmpOnlyA" class="list-disc pl-4"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Details drawer -->
  <div id="detailDrawer" class="fixed inset-0 z-40 hidden">
    <div class="absolute inset-0 bg-black/30" data-dismiss="drawer"></div>
    <aside class="absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-xl p-5 overflow-y-auto">
      <div class="flex items-center justify-between">
        <h3 id="detailTitle" class="text-lg font-semibold">Vulnerability</h3>
        <button class="btn" data-dismiss="drawer">Close</button>
      </div>
      <div id="detailBody" class="mt-4 text-sm space-y-3"></div>
    </aside>
  </div>

  <script src="./parse-sbom.js"></script>
</body>
</html>
